---
phase: 04-sequences-and-control-flow
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - crates/daq-egui/src/widgets/property_inspector.rs
  - crates/daq-egui/src/panels/experiment_designer.rs
autonomous: true

must_haves:
  truths:
    - "User can toggle between Absolute and Relative mode for Move nodes"
    - "User can check/uncheck Wait for Settle on Move nodes"
    - "User can select wait type (Duration/Threshold/Stability) for Wait nodes"
    - "User can configure frame count for Acquire nodes"
    - "User can select loop termination mode (Count/Condition/Infinite)"
    - "Device fields use autocomplete dropdown populated from device registry"
  artifacts:
    - path: "crates/daq-egui/src/widgets/property_inspector.rs"
      provides: "Full property inspector for all node types"
      contains: "show_move_inspector"
  key_links:
    - from: "crates/daq-egui/src/widgets/property_inspector.rs"
      to: "DeviceSelector"
      via: "device autocomplete in move/acquire/wait inspectors"
      pattern: "DeviceSelector::show"
    - from: "crates/daq-egui/src/panels/experiment_designer.rs"
      to: "PropertyInspector"
      via: "sidebar rendering"
      pattern: "PropertyInspector::show"
---

<objective>
Implement full property inspector panels for Move, Wait, Acquire, and Loop nodes with device autocomplete and all configuration options.

Purpose: Scientists need intuitive UI to configure all node parameters. Move needs mode toggle and settle option, Wait needs condition type selection, Acquire needs burst mode settings, Loop needs termination mode selection.

Output: Enhanced property_inspector.rs with complete node editors, DeviceSelector integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-sequences-and-control-flow/04-CONTEXT.md
@.planning/phases/04-sequences-and-control-flow/04-01-SUMMARY.md

# Code to enhance
@crates/daq-egui/src/widgets/property_inspector.rs
@crates/daq-egui/src/widgets/device_selector.rs
@crates/daq-egui/src/graph/nodes.rs
@crates/daq-egui/src/panels/experiment_designer.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Move node property inspector with DeviceSelector</name>
  <files>
    crates/daq-egui/src/widgets/property_inspector.rs
  </files>
  <action>
Refactor PropertyInspector to use DeviceSelector and show full Move node configuration:

1. Add `device_selector: DeviceSelector` field to PropertyInspector struct (or make it stateless using passed-in candidates)

2. Create `show_move_inspector(ui: &mut Ui, config: &mut MoveConfig, device_ids: &[String]) -> bool`:
   ```rust
   fn show_move_inspector(ui: &mut Ui, config: &mut MoveConfig, device_ids: &[String]) -> bool {
       let mut changed = false;

       // Device selection with autocomplete
       ui.horizontal(|ui| {
           ui.label("Device:");
           let mut selector = DeviceSelector::new(device_ids);
           selector.set_selected(&config.device);
           if selector.show(ui, "Select actuator...") {
               config.device = selector.selected().to_string();
               changed = true;
           }
       });

       // Mode toggle (Absolute / Relative)
       ui.horizontal(|ui| {
           ui.label("Mode:");
           changed |= ui.radio_value(&mut config.mode, MoveMode::Absolute, "Absolute").changed();
           changed |= ui.radio_value(&mut config.mode, MoveMode::Relative, "Relative").changed();
       });

       // Position field
       ui.horizontal(|ui| {
           let label = match config.mode {
               MoveMode::Absolute => "Position:",
               MoveMode::Relative => "Distance:",
           };
           ui.label(label);
           changed |= ui.add(egui::DragValue::new(&mut config.position).speed(0.1)).changed();
       });

       // Wait for settle checkbox
       changed |= ui.checkbox(&mut config.wait_settled, "Wait for motion to settle").changed();

       changed
   }
   ```

3. Update PropertyInspector::show() to call show_move_inspector for Move variant, passing device_ids from caller

4. Add device_ids parameter to PropertyInspector::show() signature:
   ```rust
   pub fn show(ui: &mut Ui, node: &ExperimentNode, device_ids: &[String]) -> Option<ExperimentNode>
   ```
  </action>
  <verify>
    `cargo check -p daq-egui` - Move node inspector compiles
  </verify>
  <done>
    Move node property inspector shows device autocomplete, mode toggle, position field, and settle checkbox
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Wait, Acquire, and Loop property inspectors</name>
  <files>
    crates/daq-egui/src/widgets/property_inspector.rs
  </files>
  <action>
Add property inspectors for remaining node types:

1. Create `show_wait_inspector(ui: &mut Ui, condition: &mut WaitCondition, device_ids: &[String]) -> bool`:
   - ComboBox to select condition type (Duration, Threshold, Stability)
   - Based on selection, show appropriate fields:
     - Duration: milliseconds DragValue
     - Threshold: device selector, operator ComboBox (LessThan, GreaterThan, EqualWithin), value DragValue, timeout_ms
     - Stability: device selector, tolerance DragValue, duration_ms DragValue, timeout_ms
   - When user changes type in ComboBox, create new default variant (don't lose data until confirmed)

2. Create `show_acquire_inspector(ui: &mut Ui, config: &mut AcquireConfig, device_ids: &[String]) -> bool`:
   - Device selector for detector
   - Optional exposure field with checkbox "Override exposure" + DragValue (when Some) or "Use device default" (when None)
   - Frame count DragValue with range 1..=1000 (burst mode)

3. Create `show_loop_inspector(ui: &mut Ui, config: &mut LoopConfig, device_ids: &[String]) -> bool`:
   - ComboBox for termination type (Count, Condition, Infinite)
   - Based on selection:
     - Count: iterations DragValue (1..=10000)
     - Condition: device selector, operator, value, max_iterations
     - Infinite: max_iterations (safety limit, default 10000) with warning label "Requires manual abort"

4. Wire all inspectors into PropertyInspector::show() match arms

5. Update Scan inspector to also use DeviceSelector for actuator field
  </action>
  <verify>
    `cargo check -p daq-egui` - all inspectors compile
  </verify>
  <done>
    All node types (Move, Wait, Acquire, Loop, Scan) have full property inspectors with appropriate controls
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire device list from ExperimentDesignerPanel to PropertyInspector</name>
  <files>
    crates/daq-egui/src/panels/experiment_designer.rs
  </files>
  <action>
Update ExperimentDesignerPanel to pass device_ids to PropertyInspector:

1. Find where PropertyInspector::show() is called in experiment_designer.rs

2. Pass the device list from DaqClient or cached registry:
   - If ExperimentDesignerPanel has access to device list (e.g., from DaqClient::list_devices()), pass it
   - If not cached, add `device_ids: Vec<String>` field to panel state, populated from async fetch
   - For initial implementation, can use empty Vec with TODO comment for async loading

3. Update the call site:
   ```rust
   // Before:
   PropertyInspector::show(ui, node)

   // After:
   PropertyInspector::show(ui, node, &self.device_ids)
   ```

4. If device_ids is empty, PropertyInspector should fall back to text field (graceful degradation)

5. Consider adding refresh mechanism: button in property inspector header to refetch device list
  </action>
  <verify>
    `cargo build -p daq-egui` - builds without errors
    Run GUI manually to confirm property inspector renders for node selection
  </verify>
  <done>
    PropertyInspector receives device list and shows autocomplete for device fields
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p daq-egui` - compiles successfully
2. `cargo test -p daq-egui` - tests pass
3. Manual: Run GUI, add Move node, verify property inspector shows:
   - Device autocomplete (or text field if no devices)
   - Absolute/Relative radio buttons
   - Position field that changes label based on mode
   - Wait for settle checkbox
</verification>

<success_criteria>
- Move node inspector has DeviceSelector, mode toggle, position, wait_settled
- Wait node inspector has condition type selector with appropriate fields per type
- Acquire node inspector has DeviceSelector, optional exposure override, frame count
- Loop node inspector has termination type selector with appropriate fields per type
- Scan node inspector uses DeviceSelector for actuator
- ExperimentDesignerPanel passes device_ids to PropertyInspector
</success_criteria>

<output>
After completion, create `.planning/phases/04-sequences-and-control-flow/04-02-SUMMARY.md`
</output>
