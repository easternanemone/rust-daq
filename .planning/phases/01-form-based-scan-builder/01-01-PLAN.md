---
phase: 01-form-based-scan-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/daq-egui/src/panels/scan_builder.rs
  - crates/daq-egui/src/panels/mod.rs
  - crates/daq-egui/src/app.rs
autonomous: true

must_haves:
  truths:
    - "User can see available devices from daemon grouped by type"
    - "User can select actuator and detector(s) for a scan"
    - "User can fill in 1D scan parameters (start/stop/points)"
    - "User can toggle between 1D and 2D scan modes"
  artifacts:
    - path: "crates/daq-egui/src/panels/scan_builder.rs"
      provides: "ScanBuilderPanel struct with form state and device selection"
      min_lines: 200
    - path: "crates/daq-egui/src/panels/mod.rs"
      provides: "Module export for scan_builder"
      contains: "pub use scan_builder::ScanBuilderPanel"
  key_links:
    - from: "crates/daq-egui/src/panels/scan_builder.rs"
      to: "client.list_devices()"
      via: "PendingAction::RefreshDevices async task"
      pattern: "client\\.list_devices\\(\\)"
    - from: "crates/daq-egui/src/app.rs"
      to: "ScanBuilderPanel"
      via: "Panel enum variant and dock integration"
      pattern: "ScanBuilder"
---

<objective>
Create the ScanBuilderPanel with device discovery and form-based scan configuration.

Purpose: Establish the foundational UI for scientists to configure 1D/2D parameter scans by selecting devices and entering scan parameters through a simple form interface.

Output: A new `ScanBuilderPanel` integrated into the egui dock system, with device selection (grouped by capability), 1D/2D mode toggle, and validated form fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-form-based-scan-builder/01-CONTEXT.md
@.planning/phases/01-form-based-scan-builder/01-RESEARCH.md

# Key reference implementations for async patterns:
@crates/daq-egui/src/panels/scans.rs
@crates/daq-egui/src/panels/plan_runner.rs
@crates/daq-egui/src/panels/devices.rs
@crates/daq-egui/src/panels/mod.rs
@crates/daq-egui/src/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScanBuilderPanel with form state and device discovery</name>
  <files>crates/daq-egui/src/panels/scan_builder.rs</files>
  <action>
Create a new `ScanBuilderPanel` struct following the established async patterns from `ScansPanel` and `PlanRunnerPanel`.

**Panel State:**
```rust
pub struct ScanBuilderPanel {
    // Device cache (refreshed from daemon)
    devices: Vec<DeviceInfo>,
    last_device_refresh: Option<Instant>,

    // Scan mode toggle
    scan_mode: ScanMode,  // OneDimensional or TwoDimensional

    // Device selection
    selected_actuator: Option<String>,      // 1D mode
    selected_actuator_x: Option<String>,    // 2D mode (fast axis)
    selected_actuator_y: Option<String>,    // 2D mode (slow axis)
    selected_detectors: Vec<String>,

    // 1D scan parameters (string fields for form input)
    start_1d: String,
    stop_1d: String,
    points_1d: String,

    // 2D scan parameters
    x_start: String, x_stop: String, x_points: String,
    y_start: String, y_stop: String, y_points: String,

    // Validation errors (field name -> error message)
    validation_errors: HashMap<&'static str, String>,

    // Status/error display
    status: Option<String>,
    error: Option<String>,

    // Async integration (PendingAction + mpsc pattern)
    pending_action: Option<PendingAction>,
    action_tx: mpsc::Sender<ActionResult>,
    action_rx: mpsc::Receiver<ActionResult>,
    action_in_flight: usize,
}

enum ScanMode { OneDimensional, TwoDimensional }
enum PendingAction { RefreshDevices }
enum ActionResult { DevicesLoaded(Result<Vec<DeviceInfo>, String>) }
```

**Device Discovery:**
- `refresh_devices()` method spawns async task calling `client.list_devices()`
- Group devices by capability: Actuators (is_movable), Detectors (is_readable OR is_frame_producer)
- Cache device list with timestamp for refresh-on-stale

**Form Layout:**
- 1D/2D toggle buttons at top (using `ui.selectable_value`)
- Collapsible "Actuators" section showing movable devices with combo-box selection
- Collapsible "Detectors" section showing readable devices with multi-select checkboxes
- Parameter fields based on mode:
  - 1D: Start, Stop, Points (single axis)
  - 2D: X Start/Stop/Points, Y Start/Stop/Points (two axes)
- Live preview text: "N points, ~X minutes estimated" (calculate from points and estimated dwell)

**Validation:**
- `validate_form()` method checks:
  - All numeric fields parse as valid f64/u32
  - At least one actuator selected
  - At least one detector selected
  - Points > 0
  - Start != Stop
- Red border on invalid fields via `response.highlight()`
- Tooltip on hover showing error message

Follow the `poll_async_results()` pattern from ScansPanel for handling async device refresh.
  </action>
  <verify>
- File compiles: `cargo check -p daq-egui`
- Panel struct has all required fields
- Form validation function exists and handles all error cases
  </verify>
  <done>ScanBuilderPanel struct created with form state, device selection UI, 1D/2D mode toggle, and field validation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ScanBuilderPanel into app dock system</name>
  <files>crates/daq-egui/src/panels/mod.rs, crates/daq-egui/src/app.rs</files>
  <action>
**In `crates/daq-egui/src/panels/mod.rs`:**
1. Add module declaration: `mod scan_builder;`
2. Add public export: `pub use scan_builder::ScanBuilderPanel;`

**In `crates/daq-egui/src/app.rs`:**
1. Add to Panel enum:
```rust
enum Panel {
    // ... existing variants ...
    ScanBuilder,
}
```

2. Add panel state field to DaqApp:
```rust
scan_builder_panel: ScanBuilderPanel,
```

3. In `DaqApp::new()`, initialize:
```rust
scan_builder_panel: ScanBuilderPanel::default(),
```

4. In the TabViewer implementation, add match arm for `Panel::ScanBuilder`:
```rust
Panel::ScanBuilder => {
    self.scan_builder_panel.ui(ui, self.client.as_mut(), &self.runtime);
}
```

5. Add tab title in `title()` method:
```rust
Panel::ScanBuilder => "Scan Builder",
```

6. Add to dock layout - insert as a new tab in the left panel area (alongside Devices, Scans):
- Find where GettingStarted or Devices panel is added to dock_state
- Add ScanBuilder to same surface/node for easy access

7. Add menu item in View menu (if it exists) or nav panel to open ScanBuilder tab.
  </action>
  <verify>
- `cargo check -p daq-egui` passes
- Run GUI with `cargo run -p daq-egui` and verify ScanBuilder tab appears
- Click on ScanBuilder tab and verify form renders without crash
  </verify>
  <done>ScanBuilderPanel integrated into dock system and accessible from GUI navigation</done>
</task>

<task type="auto">
  <name>Task 3: Add scan preview calculation and form polish</name>
  <files>crates/daq-egui/src/panels/scan_builder.rs</files>
  <action>
**Scan Preview Calculation:**
Add method `calculate_scan_preview()` that returns:
```rust
struct ScanPreview {
    total_points: u32,
    estimated_duration_secs: f64,
    valid: bool,
}
```

For 1D: `total_points = points`
For 2D: `total_points = x_points * y_points`

Estimated duration: `total_points * dwell_time_ms / 1000.0` (use default 100ms if not specified)

Display in UI:
```rust
let preview = self.calculate_scan_preview();
if preview.valid {
    ui.label(format!(
        "{} points, ~{} estimated",
        preview.total_points,
        format_duration(preview.estimated_duration_secs)
    ));
} else {
    ui.colored_label(Color32::GRAY, "Complete form to see preview");
}
```

**Form Polish:**
1. Add dwell_time_ms field (with sensible default of 100.0)
2. Show device current values next to names in selection:
   - Format: "Stage X (45.2 mm)" - requires querying device parameters
   - For initial implementation, just show "Device Name (device_id)"
3. Add "Refresh Devices" button that triggers device refresh
4. Show "Last refreshed X seconds ago" timestamp
5. Gray out and disable inputs when no connection (check `client.is_none()`)
6. Use `offline_notice()` widget pattern from ScansPanel when disconnected

**Helper Function:**
```rust
fn format_duration(secs: f64) -> String {
    if secs < 60.0 {
        format!("{:.0}s", secs)
    } else if secs < 3600.0 {
        format!("{:.1}min", secs / 60.0)
    } else {
        format!("{:.1}h", secs / 3600.0)
    }
}
```
  </action>
  <verify>
- Form shows live preview with point count and duration
- Refresh button works and updates device list
- Disconnected state shows offline notice
- `cargo clippy -p daq-egui` passes with no warnings
  </verify>
  <done>Scan preview calculation working, form shows estimated duration, polish complete</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cargo build -p daq-egui` succeeds
2. `cargo clippy -p daq-egui --all-targets` passes
3. GUI launches and shows ScanBuilder tab
4. Device list populates when connected to daemon
5. 1D/2D toggle changes visible form fields
6. Validation errors appear on invalid input
7. Preview shows point count and estimated time
</verification>

<success_criteria>
- ScanBuilderPanel exists with device discovery and form fields
- Panel is integrated into dock system and accessible
- 1D and 2D scan modes both have complete form layouts
- Validation provides clear feedback on invalid input
- Live preview shows total points and estimated duration
</success_criteria>

<output>
After completion, create `.planning/phases/01-form-based-scan-builder/01-01-SUMMARY.md`
</output>
