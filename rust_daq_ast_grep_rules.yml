# ast-grep rules for the rust-daq project

rules:
# Rule to find blocking calls in the GUI
- id: find-blocking-gui-calls
  language: rust
  rule:
    any:
      - pattern: $X.blocking_send($$$)
      - pattern: $X.blocking_recv($$$)
  message: "Avoid blocking calls in the GUI. Use async methods instead."
  severity: "error"
  files:
    - "src/gui/"

# Rule to find .unwrap() and .expect()
- id: no-unwrap-expect
  language: rust
  rule:
    any:
      - pattern: $X.unwrap()
      - pattern: $X.expect($$$)
  message: "Avoid using .unwrap() and .expect() outside of tests. Handle the Result properly."
  severity: "warning"
  ignores:
    - "tests/"

# Rule to find hardcoded device paths
- id: no-hardcoded-device-paths
  language: rust
  rule:
    pattern: '"/dev/ttyUSB$S"'
  message: "Avoid hardcoded device paths. Move them to a configuration file."
  severity: "warning"

# Rule to find hardcoded timeouts
- id: no-hardcoded-timeouts
  language: rust
  rule:
    pattern: Duration::from_secs($N)
  message: "Avoid hardcoded timeouts. Make them configurable."
  severity: "warning"

# Rule to find incomplete implementation comments
- id: incomplete-implementation
  language: rust
  rule:
    pattern: "// Real implementation would..."
  message: "Incomplete implementation detected. Please complete the implementation."
  severity: "info"

# Rule to find anyhow! with string literals
- id: use-specific-errors
  language: rust
  rule:
    pattern: anyhow!($S)
  message: "Consider using a more specific error type from `DaqError` instead of a generic `anyhow!` error with a string literal."
  severity: "hint"

# Rule to find println! and dbg! macros
- id: no-debug-macros
  language: rust
  rule:
    any:
      - pattern: println!($$$)
      - pattern: dbg!($$$)
  message: "Debugging macros like println! and dbg! should not be committed to production code."
  severity: "warning"
  ignores:
    - "tests/"

# Rule to discourage use of V1 Instrument trait
- id: use-v2-instrument-trait
  language: rust
  rule:
    pattern: "impl crate::core::Instrument for $NAME"
  message: "The V1 `crate::core::Instrument` trait is deprecated. Please use the V2 `daq_core::Instrument` trait instead."
  severity: "warning"
  files:
    - "src/instrument/"

# Rule to discourage use of V1 InstrumentMeasurement
- id: use-v2-measurement
  language: rust
  rule:
    pattern: "InstrumentMeasurement"
  message: "The V1 `InstrumentMeasurement` is deprecated. Please use `daq_core::Measurement` instead."
  severity: "warning"
  files:
    - "src/"
  ignores:
    - "src/instrument/v2_adapter.rs" # This file is a bridge and is expected to use V1 types

# Rule to discourage use of V2InstrumentAdapter
- id: no-v2-adapter
  language: rust
  rule:
    pattern: "V2InstrumentAdapter"
  message: "The `V2InstrumentAdapter` is a temporary compatibility layer and should be removed. Migrate the instrument to use the V2 API directly."
  severity: "info"
  files:
    - "src/"

# Rule to discourage anyhow::Result in function signatures
- id: use-daq-core-result
  language: rust
  rule:
    pattern: "fn $NAME($$$) -> anyhow::Result<$TYPE>"
  message: "Prefer using `daq_core::Result<T>` (which is a type alias for `Result<T, DaqError>`) over `anyhow::Result<T>` for more specific error handling."
  severity: "hint"

# Rule to find incomplete migration todos
- id: incomplete-migration-todo
  language: rust
  rule:
    any:
      - pattern: 'todo!("V2")'
      - pattern: 'todo!("V3")'
      - pattern: 'unimplemented!("V2")'
      - pattern: 'unimplemented!("V3")'
  message: "Incomplete V2/V3 migration task found."
  severity: "warning"

# Rule to find V1 feature flags
- id: v1-feature-flag
  language: rust
  rule:
    pattern: '#[cfg(feature = "v1-instruments")]'
  message: "This code is part of the V1 architecture and is gated by the `v1-instruments` feature. It can be removed after the V2 migration is complete."
  severity: "info"

# Rule to find std::thread::sleep in async functions
# NOTE: This rule is disabled because ast-grep doesn't support matching async keyword directly
# To detect this pattern, use clippy's `blocking_in_async` lint instead: cargo clippy -- -W clippy::blocking_in_async
# - id: std-thread-sleep-in-async
#   language: rust
#   rule:
#     pattern: std::thread::sleep($$$)
#   message: "Using `std::thread::sleep` in an async function blocks the executor. Use `tokio::time::sleep` instead. Note: This rule cannot verify the function is async - manual review required."
#   severity: "warning"

# Rule to find redundant else
- id: redundant-else
  language: rust
  rule:
    pattern: |
      if $COND {
        $$$
        return $$$;
      } else {
        $$$
      }
  message: "This `else` is redundant. The code can be simplified by removing the `else` block and un-indenting the code inside it."
  severity: "hint"

# Rule to find manual shutdown logic
- id: manual-shutdown-logic
  language: rust
  rule:
    all:
      - pattern: "tokio::time::timeout($$$).await"
      - inside:
          kind: function_item
          has:
            any:
              - pattern: "stop_instrument"
              - pattern: "stop_recording"
  message: "This function appears to have manual shutdown logic. Consider using the `shutdown_task` helper function to simplify the code and ensure consistency."
  severity: "hint"

# Rule to find .to_string() on string literals
# NOTE: Simplified to catch all .to_string() calls - manual review needed to distinguish string literals from &str
- id: string-to-string
  language: rust
  rule:
    pattern: "$S.to_string()"
  message: "Review .to_string() usage: if called on a string literal, it creates unnecessary allocation. Consider String::from() or ensure conversion from &str is needed."
  severity: "hint"
  ignores:
    - "tests/"

# Rule to find .to_owned() calls
# NOTE: Simplified to catch all .to_owned() calls - manual review needed  
- id: unnecessary-to-owned
  language: rust
  rule:
    pattern: "$S.to_owned()"
  message: "Review .to_owned() usage: if called on a string literal, consider String::from() or .to_string() for clarity."
  severity: "hint"
  ignores:
    - "tests/"