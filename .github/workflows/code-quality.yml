name: Code Quality Analysis

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: quality-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Cyclomatic Complexity Analysis
  # ============================================================================
  complexity:
    name: Complexity Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run on main push or if PR has 'ci:full' label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ci:full')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install rust-code-analysis
        run: cargo install rust-code-analysis-cli

      - name: Analyze complexity
        id: complexity
        run: |
          echo "### Cyclomatic Complexity Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Analyze all Rust source files
          HIGH_COMPLEXITY_COUNT=0
          for dir in crates/*/src; do
            if [ -d "$dir" ]; then
              CRATE_NAME=$(basename $(dirname "$dir"))
              OUTPUT=$(rust-code-analysis-cli -p "$dir" -O json 2>/dev/null || echo "{}")

              # Extract functions with cyclomatic complexity > 20
              COMPLEX=$(echo "$OUTPUT" | jq -r '
                .. | objects | select(.kind == "function" and .metrics.cyclomatic.cyclomatic > 20) |
                "\(.name): \(.metrics.cyclomatic.cyclomatic)"
              ' 2>/dev/null || echo "")

              if [ -n "$COMPLEX" ]; then
                echo "**$CRATE_NAME** - High complexity functions:" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "$COMPLEX" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                HIGH_COMPLEXITY_COUNT=$((HIGH_COMPLEXITY_COUNT + $(echo "$COMPLEX" | wc -l)))
              fi
            fi
          done

          echo "high_complexity_count=$HIGH_COMPLEXITY_COUNT" >> $GITHUB_OUTPUT

          if [ "$HIGH_COMPLEXITY_COUNT" -eq 0 ]; then
            echo "✅ No functions with cyclomatic complexity > 20" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Found $HIGH_COMPLEXITY_COUNT functions with complexity > 20" >> $GITHUB_STEP_SUMMARY
            echo "Consider refactoring these functions into smaller pieces." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run clippy with cognitive complexity
        run: |
          cargo clippy --workspace --all-targets --features full --exclude daq-egui -- \
            -W clippy::cognitive_complexity \
            -A clippy::too_many_lines 2>&1 | tee clippy-complexity.log || true

          # Extract cognitive complexity warnings
          grep -E "cognitive_complexity" clippy-complexity.log || echo "No cognitive complexity warnings"

  # ============================================================================
  # Duplicate Code Detection
  # ============================================================================
  duplicates:
    name: Duplicate Code Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run on main push or if PR has 'ci:full' label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ci:full')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Detect duplicates
        id: duplicates
        run: |
          # Configure jscpd for Rust
          cat > .jscpd.json << 'EOF'
          {
            "threshold": 5,
            "reporters": ["json", "consoleFull"],
            "ignore": [
              "**/target/**",
              "**/tests/**",
              "**/*_test.rs",
              "**/mod.rs"
            ],
            "format": ["rust"],
            "minLines": 10,
            "minTokens": 50,
            "output": "."
          }
          EOF

          # Run duplicate detection
          jscpd crates/ --output . --format rust || true

          # Parse results
          if [ -f "jscpd-report.json" ]; then
            DUPLICATE_LINES=$(jq '.statistics.total.duplicatedLines // 0' jscpd-report.json)
            DUPLICATE_PERCENTAGE=$(jq '.statistics.total.percentage // 0' jscpd-report.json)
            CLONE_COUNT=$(jq '.statistics.total.clones // 0' jscpd-report.json)

            echo "duplicate_lines=$DUPLICATE_LINES" >> $GITHUB_OUTPUT
            echo "duplicate_percentage=$DUPLICATE_PERCENTAGE" >> $GITHUB_OUTPUT
            echo "clone_count=$CLONE_COUNT" >> $GITHUB_OUTPUT

            echo "### Duplicate Code Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Duplicated Lines | $DUPLICATE_LINES |" >> $GITHUB_STEP_SUMMARY
            echo "| Duplication % | $DUPLICATE_PERCENTAGE% |" >> $GITHUB_STEP_SUMMARY
            echo "| Clone Count | $CLONE_COUNT |" >> $GITHUB_STEP_SUMMARY

            if [ "$CLONE_COUNT" -gt 10 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ High duplication detected. Consider extracting common code." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "✅ Duplication within acceptable limits." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "clone_count=0" >> $GITHUB_OUTPUT
            echo "✅ No significant duplicates found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload duplication report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: duplication-report-${{ github.sha }}
          path: jscpd-report.json
          if-no-files-found: ignore
          retention-days: 14

  # ============================================================================
  # Tech Debt Tracking (TODO/FIXME Scanner)
  # ============================================================================
  tech-debt:
    name: Tech Debt Tracking
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run on main push or if PR has 'ci:full' label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ci:full')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for TODO/FIXME markers
        id: tech-debt
        run: |
          echo "### Tech Debt Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count TODO markers
          TODO_COUNT=$(grep -r --include="*.rs" -c "TODO" crates/ | awk -F: '{sum += $2} END {print sum+0}')
          FIXME_COUNT=$(grep -r --include="*.rs" -c "FIXME" crates/ | awk -F: '{sum += $2} END {print sum+0}')
          HACK_COUNT=$(grep -r --include="*.rs" -c "HACK\|XXX" crates/ | awk -F: '{sum += $2} END {print sum+0}')

          TOTAL=$((TODO_COUNT + FIXME_COUNT + HACK_COUNT))

          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
          echo "fixme_count=$FIXME_COUNT" >> $GITHUB_OUTPUT
          echo "hack_count=$HACK_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

          echo "| Marker | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| TODO | $TODO_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| FIXME | $FIXME_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| HACK/XXX | $HACK_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY

          # List high-priority items (FIXME)
          if [ "$FIXME_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### FIXME Items (High Priority)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -rn --include="*.rs" "FIXME" crates/ | head -20 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # Fail if FIXME count is too high
          if [ "$FIXME_COUNT" -gt 20 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ High FIXME count ($FIXME_COUNT). Please address critical issues." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate tech debt report
        run: |
          # Create detailed tech debt file
          echo "# Tech Debt Report - $(date +%Y-%m-%d)" > tech-debt-report.md
          echo "" >> tech-debt-report.md

          echo "## TODO Items" >> tech-debt-report.md
          grep -rn --include="*.rs" "TODO" crates/ >> tech-debt-report.md 2>/dev/null || echo "None found" >> tech-debt-report.md
          echo "" >> tech-debt-report.md

          echo "## FIXME Items" >> tech-debt-report.md
          grep -rn --include="*.rs" "FIXME" crates/ >> tech-debt-report.md 2>/dev/null || echo "None found" >> tech-debt-report.md
          echo "" >> tech-debt-report.md

          echo "## HACK/XXX Items" >> tech-debt-report.md
          grep -rn --include="*.rs" "HACK\|XXX" crates/ >> tech-debt-report.md 2>/dev/null || echo "None found" >> tech-debt-report.md

      - name: Upload tech debt report
        uses: actions/upload-artifact@v4
        with:
          name: tech-debt-report-${{ github.sha }}
          path: tech-debt-report.md
          retention-days: 30

  # ============================================================================
  # AGENTS.md Validation
  # ============================================================================
  agents-md-validation:
    name: AGENTS.md Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run on main push or if PR has 'ci:full' label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ci:full')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-daq
        with:
          cache-key: agents-validation

      - name: Validate AGENTS.md exists
        run: |
          if [ ! -f "AGENTS.md" ]; then
            echo "::error::AGENTS.md not found in repository root"
            exit 1
          fi
          echo "✅ AGENTS.md exists"

      - name: Validate documented commands
        id: validate
        run: |
          echo "### AGENTS.md Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ERRORS=0

          # Test: cargo build works
          echo "Testing: cargo build..." >> $GITHUB_STEP_SUMMARY
          if cargo build --workspace --exclude daq-egui 2>&1; then
            echo "✅ cargo build - PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ cargo build - FAIL" >> $GITHUB_STEP_SUMMARY
            ERRORS=$((ERRORS + 1))
          fi

          # Test: cargo fmt --check works
          echo "Testing: cargo fmt --check..." >> $GITHUB_STEP_SUMMARY
          if cargo fmt --all --check 2>&1; then
            echo "✅ cargo fmt --check - PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ cargo fmt --check - formatting issues (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          # Test: cargo clippy works
          echo "Testing: cargo clippy..." >> $GITHUB_STEP_SUMMARY
          if cargo clippy --workspace --all-targets --exclude daq-egui -- -D warnings 2>&1; then
            echo "✅ cargo clippy - PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ cargo clippy - warnings present (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          # Test: cargo nextest is installable
          echo "Testing: cargo nextest availability..." >> $GITHUB_STEP_SUMMARY
          if cargo install cargo-nextest --locked 2>&1; then
            echo "✅ cargo-nextest install - PASS" >> $GITHUB_STEP_SUMMARY

            # Test: tests can be listed
            if cargo nextest list --workspace --exclude daq-egui 2>&1 | head -20; then
              echo "✅ cargo nextest list - PASS" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ cargo nextest list - FAIL" >> $GITHUB_STEP_SUMMARY
              ERRORS=$((ERRORS + 1))
            fi
          else
            echo "❌ cargo-nextest install - FAIL" >> $GITHUB_STEP_SUMMARY
            ERRORS=$((ERRORS + 1))
          fi

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

          if [ "$ERRORS" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ $ERRORS validation errors found. AGENTS.md may be out of sync with code." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All documented commands validated successfully." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for stale documentation
        run: |
          # Check if AGENTS.md references files that don't exist
          echo "Checking for stale file references..."

          # Extract file paths from AGENTS.md
          grep -oE '\b(crates|config|scripts|docs)/[a-zA-Z0-9_/-]+\.(rs|toml|md|sh)\b' AGENTS.md | sort -u > referenced_files.txt

          STALE_COUNT=0
          while read -r file; do
            if [ ! -f "$file" ]; then
              echo "⚠️ Referenced file not found: $file"
              STALE_COUNT=$((STALE_COUNT + 1))
            fi
          done < referenced_files.txt

          if [ "$STALE_COUNT" -gt 0 ]; then
            echo "::warning::Found $STALE_COUNT stale file references in AGENTS.md"
          else
            echo "✅ No stale file references found"
          fi
