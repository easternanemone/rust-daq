# Example TCP SCPI Device Plugin Configuration
#
# This example demonstrates a TCP-connected power supply using SCPI commands.
# Use this as a template for network-connected instruments that follow the
# Standard Commands for Programmable Instruments (SCPI) protocol.
#
# Typical devices: Network power supplies, spectrum analyzers, oscilloscopes

metadata:
  # Unique identifier for this instrument type
  id: "example-tcp-power-supply"

  # Human-readable name displayed in UI
  name: "Example TCP Power Supply"

  # Version of this plugin configuration
  version: "1.0.0"

  # Driver type: tcp_scpi for TCP/IP with SCPI commands
  # Options: serial_scpi, tcp_scpi, serial_raw, tcp_raw
  driver_type: "tcp_scpi"

# Protocol-specific communication settings
protocol:
  # TCP connection details (required for tcp_scpi/tcp_raw)
  tcp_host: "192.168.1.100"  # IP address or hostname
  tcp_port: 5025              # Standard SCPI port is 5025

  # Command/response line termination (SCPI standard is \n)
  termination: "\n"

  # Delay after sending each command (ms) - gives device time to process
  command_delay_ms: 50

  # Timeout for read operations (ms)
  timeout_ms: 2000

  # Note: baud_rate is ignored for TCP connections

# Commands to run when connecting to the instrument
# These typically initialize the device to a known state
on_connect:
  - cmd: "*IDN?"           # Query instrument identification
    wait_ms: 100           # Wait for response to settle
  - cmd: "*RST"            # Reset to factory defaults
    wait_ms: 500           # Reset takes longer
  - cmd: "*CLS"            # Clear status registers
  - cmd: "SYST:REM"        # Switch to remote control mode
  - cmd: "OUTP:PROT:CLE"   # Clear any protection faults

# Commands to run when disconnecting
# These typically return the device to local/manual control
on_disconnect:
  - cmd: "SYST:LOC"        # Return to local (front panel) control

# Patterns that indicate error responses from the device
# If any of these strings appear in a response, it's treated as an error
error_patterns:
  - "ERROR"
  - "INVALID COMMAND"
  - "SYNTAX ERROR"
  - "EXECUTION ERROR"

# Device capabilities - what the instrument can do
capabilities:

  # READABLE: Values that can be read/measured from the device
  readable:
    - name: "voltage"
      command: "MEAS:VOLT?"           # Query actual output voltage
      pattern: "{val:f}"               # Expects numeric response like "12.34"
      unit: "V"
      mock:
        default: 12.0                  # For testing without hardware
        jitter: 0.1                    # Random variation Â±0.1V

    - name: "current"
      command: "MEAS:CURR?"           # Query actual output current
      pattern: "{val:f}"
      unit: "A"
      mock:
        default: 0.5
        jitter: 0.02

    - name: "power"
      command: "MEAS:POW?"            # Query actual output power
      pattern: "{val:f}"
      unit: "W"
      mock:
        default: 6.0
        jitter: 0.5

    - name: "temperature"
      command: "SYST:TEMP?"           # Internal temperature sensor
      pattern: "{val:f}"
      unit: "C"
      mock:
        default: 35.0
        jitter: 2.0

  # SETTABLE: Parameters that can be configured
  settable:
    - name: "voltage_setpoint"
      set_cmd: "VOLT {val}"           # Set output voltage setpoint
      get_cmd: "VOLT?"                # Query current setpoint
      pattern: "{val:f}"
      value_type: float
      unit: "V"
      min: 0.0
      max: 30.0
      mock:
        default: 12.0
        jitter: 0.01

    - name: "current_limit"
      set_cmd: "CURR {val}"           # Set current limit
      get_cmd: "CURR?"
      pattern: "{val:f}"
      value_type: float
      unit: "A"
      min: 0.0
      max: 5.0
      mock:
        default: 1.0
        jitter: 0.01

    - name: "ovp_level"
      set_cmd: "VOLT:PROT {val}"      # Over-voltage protection level
      get_cmd: "VOLT:PROT?"
      pattern: "{val:f}"
      value_type: float
      unit: "V"
      min: 0.0
      max: 33.0
      mock:
        default: 31.0
        jitter: 0.0

    - name: "output_mode"
      set_cmd: "OUTP:MODE {val}"      # Output regulation mode
      get_cmd: "OUTP:MODE?"
      pattern: "{val}"
      value_type: enum
      options: ["CV", "CC", "CP"]     # Constant Voltage, Current, or Power
      # Note: No mock data for enums - default to first option

  # SWITCHABLE: Binary ON/OFF states
  switchable:
    - name: "output"
      on_cmd: "OUTP ON"               # Enable output
      off_cmd: "OUTP OFF"             # Disable output
      status_cmd: "OUTP?"             # Query output state
      pattern: "{val}"                # Expects "1" (on) or "0" (off)
      mock:
        default: 0.0                  # Start with output OFF
        jitter: 0.0

    - name: "ovp_enabled"
      on_cmd: "VOLT:PROT:STAT ON"    # Enable over-voltage protection
      off_cmd: "VOLT:PROT:STAT OFF"
      status_cmd: "VOLT:PROT:STAT?"
      pattern: "{val}"
      mock:
        default: 1.0                  # Start with OVP enabled
        jitter: 0.0

    - name: "beeper"
      on_cmd: "SYST:BEEP:STAT ON"    # Enable beeper for warnings
      off_cmd: "SYST:BEEP:STAT OFF"
      status_cmd: "SYST:BEEP:STAT?"
      pattern: "{val}"

  # ACTIONABLE: One-time commands that trigger actions
  actionable:
    - name: "clear_protection"
      cmd: "OUTP:PROT:CLE"            # Clear protection fault state
      wait_ms: 100

    - name: "save_state"
      cmd: "*SAV 1"                   # Save current settings to memory slot 1
      wait_ms: 500

    - name: "recall_state"
      cmd: "*RCL 1"                   # Recall settings from memory slot 1
      wait_ms: 500

    - name: "self_test"
      cmd: "*TST?"                    # Run internal self-test
      wait_ms: 5000                   # Self-test takes several seconds

  # LOGGABLE: Static metadata read once at startup
  loggable:
    - name: "serial_number"
      cmd: "*IDN?"
      pattern: "{manufacturer},{model},{val},{firmware}"
      mock:
        default: 0.0                  # Mock as numeric - real value is string
        jitter: 0.0

    - name: "firmware_version"
      cmd: "SYST:VERS?"
      pattern: "{val}"
      mock:
        default: 0.0
        jitter: 0.0

# UI Layout - defines how controls appear in the GUI
# This creates a hierarchical layout with groups and controls
ui_layout:
  - type: "group"
    label: "Output Control"
    children:
      - type: "toggle"
        target: "output"
        label: "Output Enable"

      - type: "slider"
        target: "voltage_setpoint"
        label: "Voltage Setpoint (V)"

      - type: "slider"
        target: "current_limit"
        label: "Current Limit (A)"

      - type: "dropdown"
        target: "output_mode"
        label: "Regulation Mode"

  - type: "group"
    label: "Measurements"
    children:
      - type: "readout"
        source: "voltage"
        label: "Measured Voltage"

      - type: "readout"
        source: "current"
        label: "Measured Current"

      - type: "readout"
        source: "power"
        label: "Measured Power"

      - type: "readout"
        source: "temperature"
        label: "Internal Temperature"

  - type: "group"
    label: "Protection"
    children:
      - type: "toggle"
        target: "ovp_enabled"
        label: "Over-Voltage Protection"

      - type: "slider"
        target: "ovp_level"
        label: "OVP Threshold (V)"

      - type: "button"
        action: "clear_protection"
        label: "Clear Protection Fault"

  - type: "group"
    label: "Utilities"
    children:
      - type: "button"
        action: "save_state"
        label: "Save Settings"

      - type: "button"
        action: "recall_state"
        label: "Recall Settings"

      - type: "button"
        action: "self_test"
        label: "Run Self-Test"

      - type: "toggle"
        target: "beeper"
        label: "Beeper Enable"
