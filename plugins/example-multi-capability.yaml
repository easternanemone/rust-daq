# Example Multi-Capability Serial Device Plugin
#
# This example demonstrates a complex serial device that combines multiple
# capability types: motion control, sensing, switching, and configuration.
# Think of this as a multi-function laboratory instrument like an automated
# optical stage with integrated power meter and shutter control.
#
# Use this as a template for instruments that perform multiple functions.

metadata:
  id: "example-multi-stage-sensor"
  name: "Example Multi-Function Stage System"
  version: "1.0.0"
  driver_type: "serial_scpi"

# Serial port communication settings
protocol:
  baud_rate: 115200              # High-speed serial
  termination: "\r\n"            # Windows-style line endings
  command_delay_ms: 20           # Brief pause between commands
  timeout_ms: 1000
  # tcp_host and tcp_port are omitted (only for TCP drivers)

# Initialization sequence
on_connect:
  - cmd: "*IDN?"
    wait_ms: 50
  - cmd: "*RST"
    wait_ms: 1000               # Allow hardware to reset
  - cmd: "SYST:ERR:CLE"         # Clear any error queue
  - cmd: "SYST:REM"             # Enable remote control
  - cmd: "SHUT:INIT"            # Initialize shutter mechanism
    wait_ms: 500
  - cmd: "MOT:INIT"             # Home all motion axes
    wait_ms: 3000               # Homing takes time

on_disconnect:
  - cmd: "MOT:STOP"             # Stop all motion
    wait_ms: 100
  - cmd: "SHUT:CLOSE"           # Close shutter for safety
    wait_ms: 200
  - cmd: "SYST:LOC"             # Return to local control

error_patterns:
  - "ERR"
  - "FAULT"
  - "LIMIT"                     # Motion limit switch triggered
  - "TIMEOUT"

capabilities:

  # MOVABLE: Multi-axis motion control
  # Note: This uses a different structure than readable/settable
  movable:
    axes:
      - name: "x"
        unit: "mm"
        min: 0.0
        max: 100.0

      - name: "y"
        unit: "mm"
        min: 0.0
        max: 100.0

      - name: "z"
        unit: "mm"
        min: 0.0
        max: 25.0

      - name: "theta"
        unit: "deg"
        min: 0.0
        max: 360.0

    # Command format: MOT:AXIS:POS x,y,z,theta
    set_cmd: "MOT:AXIS:POS {val}"

    # Response format: "50.0,25.5,10.2,45.0"
    get_cmd: "MOT:AXIS:POS?"
    get_pattern: "{x:f},{y:f},{z:f},{theta:f}"

  # READABLE: Multiple sensor types
  readable:
    # Optical power meter integrated into stage
    - name: "optical_power"
      command: "POW:MEAS?"
      pattern: "{val:f}W"         # Expects "0.0025W"
      unit: "W"
      mock:
        default: 0.001
        jitter: 0.0001

    # Position encoders (alternative to movable get_cmd)
    - name: "encoder_x"
      command: "ENC:X?"
      pattern: "{val:f}"
      unit: "mm"
      mock:
        default: 50.0
        jitter: 0.001             # Sub-micron noise

    - name: "encoder_y"
      command: "ENC:Y?"
      pattern: "{val:f}"
      unit: "mm"
      mock:
        default: 50.0
        jitter: 0.001

    # Limit switch status
    - name: "limit_switches"
      command: "MOT:LIM?"
      pattern: "{val}"            # Returns bitmask like "0000"
      unit: ""

    # Motion controller temperature
    - name: "motor_temp"
      command: "MOT:TEMP?"
      pattern: "{val:f}C"
      unit: "C"
      mock:
        default: 42.0
        jitter: 3.0

    # Vibration sensor (for stability monitoring)
    - name: "vibration_level"
      command: "VIB:MEAS?"
      pattern: "{val:f}"
      unit: "um/s"                # Velocity units
      mock:
        default: 2.5
        jitter: 0.5

  # SETTABLE: Configuration parameters
  settable:
    # Motion parameters
    - name: "velocity_xy"
      set_cmd: "MOT:VEL:XY {val}"
      get_cmd: "MOT:VEL:XY?"
      pattern: "{val:f}"
      value_type: float
      unit: "mm/s"
      min: 0.1
      max: 50.0
      mock:
        default: 10.0
        jitter: 0.0

    - name: "velocity_z"
      set_cmd: "MOT:VEL:Z {val}"
      get_cmd: "MOT:VEL:Z?"
      pattern: "{val:f}"
      value_type: float
      unit: "mm/s"
      min: 0.1
      max: 10.0               # Z-axis slower for safety
      mock:
        default: 2.0
        jitter: 0.0

    - name: "acceleration"
      set_cmd: "MOT:ACC {val}"
      get_cmd: "MOT:ACC?"
      pattern: "{val:f}"
      value_type: float
      unit: "mm/s^2"
      min: 10.0
      max: 500.0
      mock:
        default: 100.0
        jitter: 0.0

    # Power meter settings
    - name: "power_range"
      set_cmd: "POW:RANG {val}"
      get_cmd: "POW:RANG?"
      pattern: "{val}"
      value_type: enum
      options: ["AUTO", "1mW", "10mW", "100mW", "1W", "10W"]

    - name: "power_wavelength"
      set_cmd: "POW:WAV {val}"
      get_cmd: "POW:WAV?"
      pattern: "{val:f}"
      value_type: float
      unit: "nm"
      min: 400.0
      max: 1100.0
      mock:
        default: 780.0
        jitter: 0.0

    - name: "averaging_samples"
      set_cmd: "POW:AVER {val}"
      get_cmd: "POW:AVER?"
      pattern: "{val:i}"
      value_type: int
      min: 1.0                # Min/max as floats but represents int
      max: 100.0
      mock:
        default: 10.0
        jitter: 0.0

    # Motion trajectory mode
    - name: "trajectory_mode"
      set_cmd: "MOT:TRAJ {val}"
      get_cmd: "MOT:TRAJ?"
      pattern: "{val}"
      value_type: enum
      options: ["LINEAR", "CUBIC_SPLINE", "MIN_JERK"]

  # SWITCHABLE: Binary controls
  switchable:
    - name: "shutter"
      on_cmd: "SHUT:OPEN"
      off_cmd: "SHUT:CLOSE"
      status_cmd: "SHUT:STAT?"
      pattern: "{val}"          # "OPEN" or "CLOSED"
      mock:
        default: 0.0            # Start closed
        jitter: 0.0

    - name: "motors_enabled"
      on_cmd: "MOT:ENA ON"
      off_cmd: "MOT:ENA OFF"
      status_cmd: "MOT:ENA?"
      pattern: "{val}"          # "ON" or "OFF"
      mock:
        default: 1.0            # Start enabled
        jitter: 0.0

    - name: "autorange_power"
      on_cmd: "POW:AUTO ON"
      off_cmd: "POW:AUTO OFF"
      status_cmd: "POW:AUTO?"
      pattern: "{val}"
      mock:
        default: 1.0
        jitter: 0.0

    - name: "limit_check"
      on_cmd: "MOT:LIM:CHK ON"
      off_cmd: "MOT:LIM:CHK OFF"
      status_cmd: "MOT:LIM:CHK?"
      pattern: "{val}"
      mock:
        default: 1.0            # Always check limits for safety
        jitter: 0.0

  # ACTIONABLE: One-shot operations
  actionable:
    - name: "home_all"
      cmd: "MOT:HOME ALL"
      wait_ms: 5000             # Homing takes time

    - name: "home_xy"
      cmd: "MOT:HOME XY"
      wait_ms: 3000

    - name: "home_z"
      cmd: "MOT:HOME Z"
      wait_ms: 2000

    - name: "stop_motion"
      cmd: "MOT:STOP"
      wait_ms: 100

    - name: "zero_power"
      cmd: "POW:ZERO"           # Zero/dark calibration for power meter
      wait_ms: 2000

    - name: "clear_errors"
      cmd: "SYST:ERR:CLE"
      wait_ms: 50

    - name: "save_config"
      cmd: "CONF:SAVE"
      wait_ms: 500

    - name: "load_config"
      cmd: "CONF:LOAD"
      wait_ms: 500

  # LOGGABLE: Static metadata
  loggable:
    - name: "device_id"
      cmd: "*IDN?"
      pattern: "{val}"

    - name: "serial_number"
      cmd: "SYST:SER?"
      pattern: "{val}"

    - name: "firmware_version"
      cmd: "SYST:VERS?"
      pattern: "{val}"

    - name: "calibration_date"
      cmd: "CAL:DATE?"
      pattern: "{val}"

# Complex UI layout with nested groups
ui_layout:
  - type: "group"
    label: "Motion Control"
    children:
      - type: "toggle"
        target: "motors_enabled"
        label: "Motors Enabled"

      - type: "group"
        label: "Position Control"
        children:
          - type: "slider"
            target: "x"
            label: "X Position (mm)"

          - type: "slider"
            target: "y"
            label: "Y Position (mm)"

          - type: "slider"
            target: "z"
            label: "Z Position (mm)"

          - type: "slider"
            target: "theta"
            label: "Rotation (deg)"

      - type: "group"
        label: "Motion Settings"
        children:
          - type: "slider"
            target: "velocity_xy"
            label: "XY Velocity"

          - type: "slider"
            target: "velocity_z"
            label: "Z Velocity"

          - type: "slider"
            target: "acceleration"
            label: "Acceleration"

          - type: "dropdown"
            target: "trajectory_mode"
            label: "Trajectory Type"

      - type: "group"
        label: "Homing Operations"
        children:
          - type: "button"
            action: "home_all"
            label: "Home All Axes"

          - type: "button"
            action: "home_xy"
            label: "Home XY Only"

          - type: "button"
            action: "home_z"
            label: "Home Z Only"

          - type: "button"
            action: "stop_motion"
            label: "EMERGENCY STOP"

  - type: "group"
    label: "Optical Power Meter"
    children:
      - type: "readout"
        source: "optical_power"
        label: "Measured Power"

      - type: "toggle"
        target: "autorange_power"
        label: "Auto-Range"

      - type: "dropdown"
        target: "power_range"
        label: "Range"

      - type: "slider"
        target: "power_wavelength"
        label: "Wavelength (nm)"

      - type: "slider"
        target: "averaging_samples"
        label: "Averaging"

      - type: "button"
        action: "zero_power"
        label: "Zero/Dark Calibration"

  - type: "group"
    label: "Shutter & Safety"
    children:
      - type: "toggle"
        target: "shutter"
        label: "Shutter Open"

      - type: "toggle"
        target: "limit_check"
        label: "Limit Switch Checking"

      - type: "readout"
        source: "limit_switches"
        label: "Limit Status"

  - type: "group"
    label: "Diagnostics"
    children:
      - type: "readout"
        source: "encoder_x"
        label: "X Encoder"

      - type: "readout"
        source: "encoder_y"
        label: "Y Encoder"

      - type: "readout"
        source: "motor_temp"
        label: "Motor Temperature"

      - type: "readout"
        source: "vibration_level"
        label: "Vibration Level"

      - type: "button"
        action: "clear_errors"
        label: "Clear Error Queue"

  - type: "group"
    label: "Configuration"
    children:
      - type: "button"
        action: "save_config"
        label: "Save Config to Device"

      - type: "button"
        action: "load_config"
        label: "Load Config from Device"
