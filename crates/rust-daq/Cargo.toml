

# Keep the main crate at root for compatibility
[package]
name = "rust_daq"
version = "0.1.0"
edition = "2021"
authors = ["Your Name <you@example.com>"]
description = "A modular scientific data acquisition (DAQ) application in Rust."


[lib]
crate-type = ["cdylib", "rlib"]
name = "rust_daq"
path = "src/lib.rs"

[lints.rust]
# Enable additional safety warnings
unsafe_code = "warn"
missing_docs = "warn"

[lints.clippy]
# Safety & correctness
unwrap_used = "warn"
expect_used = "warn"
panic = "warn"
# Performance
large_futures = "warn"
large_stack_frames = "warn"
# Style
module_name_repetitions = "allow"
must_use_candidate = "warn"


[dependencies]
# Async Runtime
# tokio replaced below with correct features

daq-core = { path = "../daq-core" }
daq-proto = { path = "../daq-proto" }
daq-hardware = { path = "../daq-hardware", default-features = false }
daq-storage = { path = "../daq-storage", default-features = false }
daq-server = { path = "../daq-server", optional = true }
daq-scripting = { path = "../daq-scripting", optional = true }
daq-experiment = { path = "../daq-experiment" }
daq-plugin-api = { path = "../daq-plugin-api", optional = true }

# Standalone driver crates
daq-driver-mock = { path = "../daq-driver-mock", optional = true }
daq-driver-thorlabs = { path = "../daq-driver-thorlabs", optional = true }
daq-driver-newport = { path = "../daq-driver-newport", optional = true }
daq-driver-spectra-physics = { path = "../daq-driver-spectra-physics", optional = true }

# Memory Allocator (Microsoft Rust Guidelines: M-MIMALLOC-APPS)
# mimalloc removed (moved to daq-bin)

# GUI (updated to latest to fix macOS crash)
# GUI (updated to latest to fix macOS crash)
# GUI (updated to latest to fix macOS crash)
egui = { version = "0.30", optional = true }
eframe = { version = "0.30", features = ["persistence"], optional = true }
egui_plot = { version = "0.30", optional = true }
egui_extras = { version = "0.30", optional = true }
hdf5 = { package = "hdf5-metno", version = "0.11.0", optional = true }
arrow = { version = "57", optional = true, features = ["ipc"] }
csv = { version = "1.3.0", optional = true }
matrw = { version = "0.1.2", optional = true }
# netcdf = { version = "0.9.0", optional = true }
chrono = { version = "0.4.38", features = ["serde"] }

# Serialization & Configuration
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
config = { version = "0.14.0", features = ["toml"] }
toml = "0.8.12"
# V5 configuration system (Figment-based)
figment = { version = "0.10", features = ["toml", "env"] }

# Error Handling
anyhow = "1.0.82"
thiserror = "1.0.59"

# Scripting

# Logging
log = "0.4.21"
tracing = "0.1"

# CLI
# clap removed (moved to daq-bin)

# Concurrency & Async
async-trait = "0.1.79"
futures = "0.3.30"

# gRPC & Protobuf (for remote control API)
# tonic = { version = "0.10", default-features = false, features = ["prost", "codegen"] }
# prost = "0.12"
tokio-stream = { version = "0.1", default-features = false, features = ["sync", "net"] }
uuid = { version = "1.10", features = ["v4", "serde"] }
similar = "2.3"
sha2 = "0.10"
notify = { version = "7", optional = true } # File watching for hot-reload


[build-dependencies]
flatbuffers = "24.3.25"
flatc-rust = "0.2"
tonic-build = "0.11"

[dev-dependencies]
egui_kittest = "0.30"

[target.'cfg(not(target_arch = "wasm32"))'.dev-dependencies]
tempfile = "3.10.1"
serial_test = "3.1.1"
tokio-test = "0.4"
tracing-test = "0.2"
tracing-subscriber = { version = "0.3", features = ["registry"] }
uuid = { version = "1", features = ["v4"] }
criterion = { version = "0.5", features = ["html_reports", "async_tokio"] }
nix = { version = "0.29", features = ["term"] }
daq-driver-pvcam = { path = "../daq-driver-pvcam", features = ["mock"] }


[target.'cfg(not(target_arch = "wasm32"))'.dependencies]
hostname = "0.4"
# tokio moved to shared dependencies
tokio = { version = "1.36", default-features = false, features = ["sync", "macros", "rt-multi-thread", "time", "fs"] }
tonic = { version = "0.10", default-features = false, features = ["transport", "prost", "codegen"] }
prost = "0.12"
serialport = { version = "4.3.0", optional = true }
tokio-serial = { version = "5.4", optional = true }
# pvcam-sys = { path = "pvcam-sys", optional = true }
visa-rs = { version = "0.5", optional = true }

[target.'cfg(target_arch = "wasm32")'.dependencies]
# tokio moved to shared dependencies
tokio = { version = "1.36", default-features = false, features = ["sync", "macros", "rt", "time"] }
wasm-bindgen = "0.2"
wasm-bindgen-futures = "0.4"
console_error_panic_hook = "0.1"
tracing-wasm = "0.2"
# tonic-web-wasm-client = { version = "0.5", default-features = false }
getrandom-02 = { package = "getrandom", version = "0.2", features = ["js"] }
getrandom = { version = "0.3", features = ["wasm_js"] }
gloo-timers = { version = "0.3", features = ["futures"] }
web-sys = { version = "0.3", features = ["Window", "Document", "HtmlCanvasElement", "Element", "HtmlElement", "Node", "Performance", "Location", "Headers", "Request", "RequestInit", "Response", "console"] }
prost = "0.12"
tonic = { version = "0.11", default-features = false, features = ["prost", "codegen"] }
tonic-web-wasm-client = "0.5"
web-time = "1.1"

[features]
# Simplified feature flags (bd-0aqw)
default = ["storage_csv", "serial"]

# High-level Profiles
backend = ["server", "modules", "all_hardware", "storage_csv"]
frontend = ["gui_egui", "networking"]
cli = ["all_hardware", "storage_csv", "scripting", "scripting_python"]
full = ["storage_csv", "storage_arrow", "storage_matlab", "serial", "modules", "server", "all_hardware"]

# NOTE: storage_hdf5 requires native HDF5 installation (libhdf5-dev).
# Omitted from "full" to keep CI working. Enable with --features storage_hdf5.

# Storage backends
storage_csv = ["dep:csv"]
storage_hdf5 = ["dep:hdf5", "daq-storage/storage_hdf5"]
storage_arrow = ["dep:arrow", "daq-storage/storage_arrow", "daq-core/storage_arrow"]
storage_matlab = ["dep:matrw"]

# Serial communication (async via tokio-serial)
serial = ["dep:tokio-serial", "dep:serialport", "daq-hardware/serial"]
visa = ["dep:visa-rs"]

# Mock drivers for testing
mock = ["dep:daq-driver-mock"]

# Hardware drivers (standalone crates)
thorlabs = ["serial", "dep:daq-driver-thorlabs"]
newport = ["serial", "dep:daq-driver-newport"]
spectra_physics = ["serial", "dep:daq-driver-spectra-physics"]
newport_power_meter = ["newport"]

# PVCAM camera support
pvcam = ["serial", "daq-hardware/pvcam"]
pvcam_sdk = ["pvcam", "daq-hardware/pvcam_sdk"]
pvcam_hardware = ["pvcam_sdk"]

# All hardware drivers (with mock PVCAM)
all_hardware = ["thorlabs", "newport", "spectra_physics", "newport_power_meter", "pvcam"]

# Networking and server
networking = []
server = ["networking", "dep:daq-server", "tokio/full"]
scripting = ["dep:daq-scripting"]
gui_egui = ["dep:egui", "dep:eframe", "dep:egui_plot", "dep:egui_extras"]
modules = ["scripting"]

# Testing
hardware_tests = []
prime_95b_tests = []

# Python scripting backend
scripting_python = ["daq-scripting/python"]

# Plugin hot-reload (development only)
plugins_hot_reload = ["dep:notify"]

# Native plugin loading (abi_stable)
native_plugins = ["dep:daq-plugin-api"]

# Binaries and Examples moved to separate crates
# [[bin]]
# name = "rust_daq"
# path = "src/main.rs"

# [[bin]]
# name = "rust_daq_gui_egui"
# path = "src/gui_main.rs"
# required-features = ["networking", "gui_egui"]

# [[bin]]
# name = "discovery"
# path = "tools/discovery/main.rs"
# required-features = ["instrument_serial"]

# [[bin]]
# name = "quick_test"
# path = "tools/discovery/quick_test.rs"
# required-features = ["instrument_serial"]

# [[bin]]
# name = "script_runner"
# path = "tools/script_runner/main.rs"

# [[example]]
# name = "test_maitai_serial"
# path = "examples/test_maitai_serial.rs"
# required-features = ["tokio_serial"]

# [[example]]
# name = "grpc_server_demo"
# required-features = ["networking"]

# [[example]]
# name = "hw_polarization_test"
# path = "examples/hw_polarization_test.rs"
# required-features = ["instrument_thorlabs", "instrument_spectra_physics", "instrument_newport_power_meter"]

[[bench]]
name = "parameter_bench"
harness = false

[[bench]]
name = "ring_buffer"
harness = false

[package.metadata.cargo-machete]
ignored = [
    # Build dependencies
    "tonic-build", "flatc-rust",
    # Feature-gated optional deps
    "csv", "matrw", "netcdf", "hdf5", "arrow", "notify", "serialport", "tokio-serial", "visa-rs",
    "egui", "eframe", "egui_plot", "egui_extras",
    # Platform-specific deps
    "hostname", "tracing-wasm", "getrandom", "getrandom-02", "prost",
    # Dev deps
    "tracing-test",
    # Used via macros/derives
    "thiserror",
]
