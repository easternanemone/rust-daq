[package]
name = "scripting"
version = "0.1.0"
edition = "2021"

[dependencies]
common = { path = "../common", features = ["serial"] }
hardware = { path = "../hardware" }
experiment = { path = "../experiment" }
daq-driver-mock = { path = "../daq-driver-mock" }
thiserror.workspace = true
async-trait.workspace = true
tokio = { workspace = true, features = ["sync", "time", "rt", "rt-multi-thread", "macros", "signal"] }
chrono.workspace = true
rhai = { version = "1.19", features = ["sync"] }
pyo3 = { version = "0.24", features = ["auto-initialize"], optional = true }
tracing.workspace = true
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
anyhow.workspace = true

# Optional hardware driver dependencies for factory functions
daq-driver-thorlabs = { path = "../daq-driver-thorlabs", optional = true }
daq-driver-newport = { path = "../daq-driver-newport", optional = true }
daq-driver-spectra-physics = { path = "../daq-driver-spectra-physics", optional = true }
daq-driver-comedi = { path = "../daq-driver-comedi", optional = true }

# Optional HDF5 support for data storage (use hdf5-metno to match ui/daq-storage)
hdf5 = { package = "hdf5-metno", version = "0.11.0", optional = true }
ndarray = { version = "0.15", optional = true }

[features]
default = []
python = ["dep:pyo3"]
# HDF5 data storage from Rhai scripts
hdf5_scripting = ["dep:hdf5"]
# Comedi DAQ support for analog I/O and digital I/O
comedi_scripting = ["dep:daq-driver-comedi"]
# Marker feature for cfg guards on hardware factory functions
hardware_factories = []

# Generic Serial Driver support for Rhai
generic_driver = ["hardware/serial", "hardware/scripting"]

# Full scripting - RECOMMENDED
scripting_full = [
    "hardware_factories",
    "generic_driver",
    "dep:daq-driver-thorlabs",
    "dep:daq-driver-newport",
    "dep:daq-driver-spectra-physics",
    "hdf5_scripting",
]
# Full scripting with Comedi DAQ support (requires comedilib on Linux)
scripting_full_comedi = [
    "scripting_full",
    "comedi_scripting",
]
# Alias for backwards compatibility (prefer scripting_full)
polarization = ["scripting_full"]

[[bin]]
name = "rhai-runner"
path = "src/bin/rhai_runner.rs"
required-features = ["scripting_full"]

[lints]
workspace = true
