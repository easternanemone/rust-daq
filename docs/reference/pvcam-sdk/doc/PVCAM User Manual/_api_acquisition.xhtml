<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PVCAM: Image Acquisition Functions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="PM_logo_html.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PVCAM
   &#160;<span id="projectnumber">3.10.x</span>
   </div>
   <div id="projectbrief">Programmable Virtual Camera Access Method library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_api_acquisition.xhtml','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Image Acquisition Functions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>PVCAM provides two main image acquisition modes: a sequence acquisition and a continuous (circular buffer) acquisition. In both these modes the image collection process is identical: based on current camera configuration, PVCAM tells the application how large frame buffer to allocate. The application then allocates the frame buffer and passes it back to PVCAM when starting the acquisition. The behavior of these two acquisition modes, however, is slightly different.</p>
<p>With sequence acquisition, the application specifies the desired number of frames to acquire, and then starts the acquisition. The camera internally counts the frames and automatically stops the acquisition once the desired number of frames is transferred. This mode is useful when acquiring one frame or short bursts of frames. In most situations this mode is also more reliable as there are no buffer overwrites involved - a large buffer is allocated for the entire sequence of frames before the acquisition. When external hardware signals are involved, this mode also ensures that the number of pulses on the external signals corresponds to the number of frames acquired - the camera knows the desired number of frames and stops signaling when all the frames are acquired.</p>
<p>With continuous acquisition, the application does not specify the number of frames to acquire, instead, the application allocates a reasonably sized circular buffer and initiates the acquisition. The camera is acquiring freely until the application aborts the acquisition. The application is also responsible for collecting the incoming frames as fast as possible to avoid buffer overruns and thus lost frames. The size of the circular buffer - the number of frames the buffer can hold - is completely under the control of the application, however, since the buffer acts as a load leveling entity, it is recommended that the buffer is large enough to hold at least 500ms of acquisition. This will ensure that the frames are reliably delivered even if the operating system becomes momentarily less responsive. While the application can count the incoming frames and abort the acquisition once the desired number of frames is delivered (emulating the sequence mode), it is not guaranteed that the camera will acquire exactly the number of frames the application counted - with fast acquisitions and in-camera buffers involved, the camera may already be acquiring and hardware-signaling the N+5th frame while the application just received the Nth frame.</p>
<h1><a class="anchor" id="secApiAcqFns"></a>
Available Functions</h1>
<ul>
<li>State-changing functions:<ul>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> - configures the sequence acquisition</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga1bce6e5362bf81e6a3110e656fe83ba1" title="Sets circular buffer mode. ">pl_exp_setup_cont</a> - configures the continuous acquisition</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga3f0f73b953b6c1c4eeff57e6fe165f35" title="Begins exposing, returns immediately. ">pl_exp_start_seq</a> - starts the sequence acquisition</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga131ec00bebb390c250d3f39756afd35d" title="Begins continuous readout into circular buffer. ">pl_exp_start_cont</a> - starts the continuous acquisition</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga5132404e942666bd1dfdd142ebc96cd3" title="Stops collecting data, cleans up device driver, halts camera. ">pl_exp_abort</a> - stops the currently running acquisition</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#gaf427e2f2679d268c8bda4cd653d0665f" title="Finishes and cleans up after pl_exp_start_seq. ">pl_exp_finish_seq</a> - finishes internal processing after the sequence acquisition completes</li>
</ul>
</li>
<li>Callback-related functions:<ul>
<li><a class="el" href="group__grp__pm__functions.xhtml#gade7bbd577d2ed19efc749c2d4dc7627a" title="Installs a handler function that will be called when an event occurs in a camera providing informatio...">pl_cam_register_callback_ex3</a> - registers or replaces a callback handler function for a given event</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#gafc669e2098290b0198e7cfc1eeba4d5c" title="Uninstalls a handler function for camera system event. ">pl_cam_deregister_callback</a> - unregisters the callback handler function for a given callback event</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#gae563096dfcd55e57e928aba08944aaec" title="Returns pointer to the most recent frame in circular buffer. ">pl_exp_get_latest_frame_ex</a> - returns a pointer to the newest frame in buffer</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#gab57608dd33d38e4b4a6d3826c18707e3" title="This function returns pointer to the oldest unretrieved frame in the circular buffer. ">pl_exp_get_oldest_frame_ex</a> - returns a pointer to the oldest frame in buffer</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga6b399e76a92a3648acc74c186bacef07" title="Makes oldest frame in circular buffer overwritable. ">pl_exp_unlock_oldest_frame</a> - allows PVCAM to overwrite the oldest frame in the buffer with a new data</li>
</ul>
</li>
<li>Polling-related functions:<ul>
<li><a class="el" href="group__grp__pm__functions.xhtml#gada614700e6913f464a0c4553faf1d394" title="Checks the status of sequence acquisition. ">pl_exp_check_status</a> - provides current readout status and number of bytes transferred during the sequence acquisition</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga773a00c0eeab645b5df23cd718b35862" title="Checks the continuous readout status from the camera into the circular buffer. ">pl_exp_check_cont_status_ex</a> - provides current readout status and number of bytes transferred during the continuous acquisition</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="secApiAcqConfiguration"></a>
Acquisition Configuration</h1>
<p>A typical acquisition cycle consists of the following steps:</p><ul>
<li>Set PVCAM parameters via <a class="el" href="group__grp__pm__functions.xhtml#gaa69957bd29e392a02e864239d956057a" title="Sets the current value for a PVCAM parameter. ">pl_set_param</a> function (more on this in <a class="el" href="_api_parameters.xhtml">Parameter Access Functions</a> chapter).</li>
<li>Apply current settings and new parameter values to the hardware by calling <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> or <a class="el" href="group__grp__pm__functions.xhtml#ga1bce6e5362bf81e6a3110e656fe83ba1" title="Sets circular buffer mode. ">pl_exp_setup_cont</a>. As input to these functions:<ul>
<li>specify the region(s) to be collected by filling the <a class="el" href="structrgn__type.xhtml">rgn_type</a> structure (see <a class="el" href="_multi_roi_acq.xhtml">Multiple ROI Acquisition</a> chapter if more than one region is needed)</li>
<li>specify the exposure time</li>
<li>specify exposure- and expose out- modes (see <a class="el" href="_exposure_modes.xhtml">Exposure Modes</a> chapter)</li>
</ul>
</li>
<li>Start the acquisition by calling <a class="el" href="group__grp__pm__functions.xhtml#ga3f0f73b953b6c1c4eeff57e6fe165f35" title="Begins exposing, returns immediately. ">pl_exp_start_seq</a> or <a class="el" href="group__grp__pm__functions.xhtml#ga131ec00bebb390c250d3f39756afd35d" title="Begins continuous readout into circular buffer. ">pl_exp_start_cont</a> with a pre-allocated buffer</li>
<li>Monitor the progress of data collection:<ul>
<li>by use of callback handlers (recommended)</li>
<li>or by calling <a class="el" href="group__grp__pm__functions.xhtml#gada614700e6913f464a0c4553faf1d394" title="Checks the status of sequence acquisition. ">pl_exp_check_status</a> or <a class="el" href="group__grp__pm__functions.xhtml#gaa4b5fdb4751ac753b7fc644f12c3aeaf" title="Checks the continuous readout status from the camera into the circular buffer. ">pl_exp_check_cont_status</a> in a polling loop</li>
<li>for details read <a class="el" href="_polling_vs_callbacks.xhtml">Polling versus Callbacks</a></li>
</ul>
</li>
<li>Aborting acquisition is possible at any time by calling <a class="el" href="group__grp__pm__functions.xhtml#ga5132404e942666bd1dfdd142ebc96cd3" title="Stops collecting data, cleans up device driver, halts camera. ">pl_exp_abort</a>.<ul>
<li>Sequence acquisition stops automatically at the end of the sequence, but <a class="el" href="group__grp__pm__functions.xhtml#gaf427e2f2679d268c8bda4cd653d0665f" title="Finishes and cleans up after pl_exp_start_seq. ">pl_exp_finish_seq</a> should be called before a new acquisition is started.</li>
<li>Continuous acquisition can also be interrupted by calling <a class="el" href="group__grp__pm__functions.xhtml#ga33245f0696265888bebaa77612263fb8" title="Stops continuous readout acquisition. Identical to pl_exp_abort. ">pl_exp_stop_cont</a>. Internally, its functionality is identical to <a class="el" href="group__grp__pm__functions.xhtml#ga5132404e942666bd1dfdd142ebc96cd3" title="Stops collecting data, cleans up device driver, halts camera. ">pl_exp_abort</a>.</li>
</ul>
</li>
</ul>
<p>When configuring an acquisition, the following settings affect the camera behavior before and during the exposure and readout. All the settings combinations are described in detail in <a class="el" href="_exposure_loops.xhtml">Exposure Loops</a> chapter.</p><ul>
<li><a class="el" href="group__grp__pm__parameters.xhtml#gaf83462823bb83fd66af2a88a93f95820" title="Defines when clearing takes place. ">PARAM_CLEAR_MODE</a> parameter determines if and when the sensor is cleared of charge. Modern sCMOS cameras handle clearing internally (see <a class="el" href="_clear_modes.xhtml">Clear Modes</a> chapter).</li>
<li><a class="el" href="group__grp__pm__parameters.xhtml#ga9fcc39a6f09f988d1e8f3b7f9074711b" title="The shutter opening condition. ">PARAM_SHTR_OPEN_MODE</a> parameter determines if and when the shutter opens. Since modern cameras are not equipped with physical shutters, this parameter controls the Shutter Out signal behavior on the camera trigger port.</li>
<li>Exposure start mode as defined by <a class="el" href="pvcam_8h.xhtml#a87e600ad1eddc9da1c83b8f9167cf98e">PL_EXPOSURE_MODES</a> constants that determine whether an API call or an external trigger starts the exposure. Passed as an argument to <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> or <a class="el" href="group__grp__pm__functions.xhtml#ga1bce6e5362bf81e6a3110e656fe83ba1" title="Sets circular buffer mode. ">pl_exp_setup_cont</a> functions.</li>
<li>Expose out behavior as defined by <a class="el" href="pvcam_8h.xhtml#a6970cf2b3b0a3b407448a70e4ae9ec97">PL_EXPOSE_OUT_MODES</a> constants that determine the behavior of the Expose Out trigger signal during the acquisition. The value is combined with exposure start mode and passed as an argument in the <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> or <a class="el" href="group__grp__pm__functions.xhtml#ga1bce6e5362bf81e6a3110e656fe83ba1" title="Sets circular buffer mode. ">pl_exp_setup_cont</a> functions.</li>
</ul>
<p>Some trigger, shutter and clearing options only apply to multiple-frame acquisitions.</p>
<h1><a class="anchor" id="secApiAcqFrameCount"></a>
Buffer Size and Frame Count Limitations</h1>
<p>The following has to be taken into account when creating and configuring acquisition buffer size:</p>
<ul>
<li>Currently, the maximum allowed buffer size passed into <a class="el" href="group__grp__pm__functions.xhtml#ga3f0f73b953b6c1c4eeff57e6fe165f35" title="Begins exposing, returns immediately. ">pl_exp_start_seq</a> and <a class="el" href="group__grp__pm__functions.xhtml#ga131ec00bebb390c250d3f39756afd35d" title="Begins continuous readout into circular buffer. ">pl_exp_start_cont</a> is:<ul>
<li>4GB with USB interface on both Windows and Linux platforms</li>
<li>4GB with PCIe interface on Linux</li>
<li>2GB with PCIe interface on Windows</li>
</ul>
</li>
<li>the maximum number of images to acquire passed to <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> is given by by the size of buffer divided by the size of one frame with the upper limit of 65,535 frames</li>
<li>in continuous mode, the total number of frames the circular buffer can hold before the oldest frame is overwritten with the latest frame, is given by the buffer size divided by the size of one frame</li>
</ul>
<h1><a class="anchor" id="secApiAcqSequence"></a>
Sequence Acquisition</h1>
<p>Sequence is a programmed series of exposures started by a single command. In the basic scenario, after the setup is called, camera takes a series of exposures where each exposure is captured with the same acquisition settings. </p><div class="image">
<img src="Sequences.png" alt="Sequences.png"/>
</div>
<p>In most acquisition modes, new setup must be loaded to the camera if an acquisition parameter needs to be modified. In Variable Timed Mode (VTM), <code>exposure_time</code> can be modified for the next sequence (see <a class="el" href="group__grp__pm__parameters.xhtml#ga650c9a5e18d4e5d6ccfb7b989ea0258d" title="Used to examine and change the exposure time in VTM only. ">PARAM_EXP_TIME</a>). Please note the VTM mode is a camera-specific feature that has been replaced with SMART streaming.</p>
<dl class="section note"><dt>Note</dt><dd>Refer to the <a class="el" href="_ex__image_sequence.xhtml">Image Sequence</a> code sample to obtain more information on Image Sequences.</dd></dl>
<h1><a class="anchor" id="secApiAcqContinuous"></a>
Continuous Acquisition</h1>
<p>Continuous or circular buffer mode is a special case of acquisition. In a sequence, the number of frames to acquire has to be specified and a buffer large enough to hold all the frames has to be allocated prior to starting the acquisition. In circular buffer mode, the camera will keep acquiring frames until stopped by the user.</p>
<p>This mode is often used when imaging events without prior knowledge of their time occurrence, or when "focus loop" needs to be implemented.</p>
<p>With circular buffer, the data is written to the buffer sequentially until the end of buffer is reached. Afterwards, writing continues from the beginning of the buffer overwriting the previously saved image data.</p>
<p>Circular buffer also acts as a load-leveling mechanism between the camera and the application. If the application cannot temporarily keep up with camera, the circular buffer will hold the incoming frames and deliver them to the application in a burst once the application is unblocked. Since the CPU availability is not guaranteed by the OS, the buffering is particularly useful with high speed cameras. For reliable frame delivery the circular buffer size allowing storage of at least one second of acquisition is recommended.</p>
<p>With a frame of 512x512 pixels, 2 bytes per pixel and acquisition running at 400FPS this translates to a buffer size of approx. 200MB (512x512x2x400). Note the actual frame size always needs to be obtained from <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> or <a class="el" href="group__grp__pm__functions.xhtml#ga1bce6e5362bf81e6a3110e656fe83ba1" title="Sets circular buffer mode. ">pl_exp_setup_cont</a> calls as additional metadata or specific alignment may affect the size of one frame.</p>
<p><a class="el" href="group__grp__pm__parameters.xhtml#gaa59baf1e35daee986f83e5ad96cf7693" title="Retrieves the min, max, current and recommended (default) buffer size in bytes. ">PARAM_FRAME_BUFFER_SIZE</a> can be used to retrieve the recommended buffer size for the current acquisition.</p>
<p>A buffer allocated by the application needs to be passed into <a class="el" href="group__grp__pm__functions.xhtml#ga131ec00bebb390c250d3f39756afd35d" title="Begins continuous readout into circular buffer. ">pl_exp_start_cont</a> to serve as a circular buffer for the incoming data. Depending on the circular buffer "overwrite" mode, buffer overrun may be flagged as an error.</p>
<p>An example of circular buffer setup using callbacks:</p><ul>
<li><a class="el" href="group__grp__pm__deprecated__functions.xhtml#gaa312a9e5e57738a7bc23f86bb7e7c82a">pl_cam_register_callback</a> is called to register a handler for EOF camera events. This only needs to be done once as the handling function pointer is retained by PVCAM.</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga1bce6e5362bf81e6a3110e656fe83ba1" title="Sets circular buffer mode. ">pl_exp_setup_cont</a>(<a class="el" href="pvcam_8h.xhtml#ab39494f90d801ea86b3aac8a4f794b79ae8ac7755fecfcdbf4bf40276209454cb">CIRC_OVERWRITE</a>) - The circular buffer mode is selected.</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#gabae50780da6c680d41331980f3135e55" title="Returns the requested attribute for a PVCAM parameter. ">pl_get_param</a>(<a class="el" href="group__grp__pm__parameters.xhtml#gaa59baf1e35daee986f83e5ad96cf7693" title="Retrieves the min, max, current and recommended (default) buffer size in bytes. ">PARAM_FRAME_BUFFER_SIZE</a>, <a class="el" href="pvcam_8h.xhtml#a4964cf649379135a35524118cdd576e9a4543c0cc54cf1adf7ab48a74f0b418bb">ATTR_DEFAULT</a>) is called to retrieve the recommended size in bytes for the currently configured acquisition. (optional)</li>
<li>Circular buffer allocation by the application takes place here.</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga131ec00bebb390c250d3f39756afd35d" title="Begins continuous readout into circular buffer. ">pl_exp_start_cont</a> - Continuous data acquisition is started.</li>
<li>Image data starts arriving in the buffer.</li>
<li>For each new frame delivered to the buffer, the previously registered callback routine is called by PVCAM to notify the application.</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#gacaf3f951e13c29c5eb6b17addfb82ae0" title="This function returns a pointer to the most recently acquired frame in the circular buffer...">pl_exp_get_latest_frame</a> is called by the application from within the callback routine to get the pointer to the latest unretrieved frame in the circular buffer.</li>
<li>If multiple frame notifications are queued in PVCAM, the handling routine will be called again as soon as the current handler exits.</li>
<li>Data is processed by the application (display, storage etc.).</li>
<li><a class="el" href="group__grp__pm__functions.xhtml#ga5132404e942666bd1dfdd142ebc96cd3" title="Stops collecting data, cleans up device driver, halts camera. ">pl_exp_abort</a> or <a class="el" href="group__grp__pm__functions.xhtml#ga33245f0696265888bebaa77612263fb8" title="Stops continuous readout acquisition. Identical to pl_exp_abort. ">pl_exp_stop_cont</a> is called to stop the acquisition.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Please, refer to the <a class="el" href="_ex__live_image.xhtml">Live Image</a> code sample to obtain more information on Continuous Acquisition usage. </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="_pvcam_api.xhtml">API Manual</a></li>
    <li class="footer">
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a></li>
  </ul>
</div>
</body>
</html>
