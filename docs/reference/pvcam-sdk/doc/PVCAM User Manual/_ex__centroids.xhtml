<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PVCAM: Centroids</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="PM_logo_html.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PVCAM
   &#160;<span id="projectnumber">3.10.x</span>
   </div>
   <div id="projectbrief">Programmable Virtual Camera Access Method library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_ex__centroids.xhtml','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Centroids </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This code sample demonstrates how to configure the camera for Centroids acquisition. Centroids are small regions of interest that are selected by the camera based on results from in-camera image analysis. The approach for decoding the regions from the image buffer is exactly the same as with acquisitions where regions are selected by the user (see <a class="el" href="_ex__multiple_regions.xhtml">Multiple Regions</a> example). However, as the Centroids counts and locations may change with every frame, special precautions may be required on the application side to handle this dynamic behavior.</p>
<p>For general information about Centroids acquisition please refer to <a class="el" href="_centroids.xhtml">Centroids</a> chapter.</p>
<p>The code snippet below initializes PVCAM and opens the first available camera. Please, refer to the actual code sample in the SDK installation directory for more details about the common helper functions used in this documentation. </p><div class="fragment"><div class="line">std::vector&lt;CameraContext*&gt; contexts;</div><div class="line"><span class="keywordflow">if</span> (!InitAndOpenOneCamera(contexts, cSingleCamIndex))</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line">CameraContext* ctx = contexts[cSingleCamIndex];</div></div><!-- fragment --><p>This code example uses the recommended callbacks acquisition (see <a class="el" href="_polling_vs_callbacks.xhtml">Polling versus Callbacks</a>). A part of the code omitted here defines a static callback function and registers the function with PVCAM. This approach is used in other code samples as well. The relevant code part is described in <a class="el" href="_ex__common_functions.xhtml#secExCallbackHandler">Frame Callback Handler</a> section.</p>
<p>As the Centroids feature is not supported by all camera models, a check for the feature availability is recommended. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (!IsParamAvailable(ctx-&gt;hcam, <a class="code" href="group__grp__pm__parameters.xhtml#ga9993dbccb54c02e3f388943aa081dae4">PARAM_CENTROIDS_ENABLED</a>, <span class="stringliteral">&quot;PARAM_CENTROIDS_ENABLED&quot;</span>))</div><div class="line">{</div><div class="line">    CloseAllCamerasAndUninit(contexts);</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line">}</div></div><!-- fragment --><p>If the feature is available, we can now access the <a class="el" href="group__grp__pm__parameters.xhtml#ga398794c693c203822ed3d79333b3d534" title="This parameter is used to control the number of Centroids. ">PARAM_CENTROIDS_COUNT</a> to retrieve and configure the maximum number of regions the camera can generate. Another parameter, the <a class="el" href="group__grp__pm__parameters.xhtml#ga79de56ce6456eb8efa467b5a718a585f" title="This parameter is used to set the Centroid radius. ">PARAM_CENTROIDS_RADIUS</a>, can be used to configure the desired size of the regions.</p>
<p>The centroids feature requires frame metadata feature to be enabled, therefore, before starting the Centroids acquisition, the <a class="el" href="group__grp__pm__parameters.xhtml#gafc3156ccc977b2f415c7db119f63bccb" title="Parameter used to enable or disable the embedded frame metadata feature. ">PARAM_METADATA_ENABLED</a> needs to be set to <code>TRUE</code>.</p>
<p>Prepare the acquisition. The <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> function returns the size of the frame buffer required for the acquisition. For Centroids acquisition, the input region defines the bounding rectangle where the camera will search for events. The resulting ROIs will all originate from within this boundary region. For general information about how to set up a sequence acquisition please refer to <a class="el" href="_api_acquisition.xhtml#secApiAcqConfiguration">Acquisition Configuration</a>. Please note that newer cameras also support <a class="el" href="group__grp__pm__parameters.xhtml#gab710e24782520caa44c7929c41701c54" title="Supported Centroids background frame processing count. ">PARAM_CENTROIDS_BG_COUNT</a> and <a class="el" href="group__grp__pm__parameters.xhtml#ga033d6b3b34491375363f5360ab4856d9" title="Used to configure threshold multiplier for specific object detection modes. ">PARAM_CENTROIDS_THRESHOLD</a> parameters. Depending on the light level and number of frames requested, these parameters may need to be adjusted as well. If these parameters are not adjusted, the camera may not be able to locate any events in the image and may send empty frames with no centroids. </p><div class="fragment"><div class="line"><a class="code" href="master_8h.xhtml#ab84043a15f748ed8dfde8735af5b91d4">uns32</a> exposureBytes;</div><div class="line"><span class="keyword">const</span> <a class="code" href="master_8h.xhtml#ab84043a15f748ed8dfde8735af5b91d4">uns32</a> exposureTime = 10; <span class="comment">// milliseconds</span></div><div class="line"><span class="keyword">const</span> <a class="code" href="master_8h.xhtml#a65d4f91467e0293f3598f24874963944">uns16</a> framesToAcquire = 5;</div><div class="line"><span class="keyword">const</span> <a class="code" href="master_8h.xhtml#a4355d16fcf9f644c9ac84293f0b1801f">int16</a> exposureMode = <a class="code" href="pvcam_8h.xhtml#ae58cbefb2e4749ed1bab7c8f34a49aafa95355251d3c779173fa2c923e70ae814">EXT_TRIG_INTERNAL</a> | <a class="code" href="pvcam_8h.xhtml#ac61b7066f56632f10e72ef738b13e42eab36b9ef9906e77836c1677f3299b6ead">EXPOSE_OUT_FIRST_ROW</a>;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d">pl_exp_setup_seq</a>(ctx-&gt;hcam, framesToAcquire, 1, &amp;ctx-&gt;region,</div><div class="line">            exposureMode, exposureTime, &amp;exposureBytes))</div><div class="line">{</div><div class="line">    PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(), <span class="stringliteral">&quot;pl_exp_setup_seq() error&quot;</span>);</div><div class="line">    CloseAllCamerasAndUninit(contexts);</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line">}</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>For detailed information about error handling, please, refer to <a class="el" href="_ex__common_functions.xhtml#secExErrors">Getting Error Messages</a>. </dd>
<dd>
This example uses the extended trigger mode configuration and sets up the camera to use internal trigger with first-row expose out mode. However, legacy cameras do not support the extended modes and the list of supported expose out modes may differ as well. It is important to always discover the supported modes using the <a class="el" href="group__grp__pm__parameters.xhtml#gaade3260c7b5cb8b045877f4c787862ea" title="The exposure/triggering mode. ">PARAM_EXPOSURE_MODE</a> and <a class="el" href="group__grp__pm__parameters.xhtml#ga011fbd7526ab9b8fd3c3ea38fec232de" title="The Expose Out mode. ">PARAM_EXPOSE_OUT_MODE</a> parameters when working with multiple camera models.</dd></dl>
<p>Allocate a buffer of the size reported by the <a class="el" href="group__grp__pm__functions.xhtml#ga3056f74615f53b469c68d4d1c2d9f47d" title="Prepares the camera to perform a readout. ">pl_exp_setup_seq</a> function. </p><div class="fragment"><div class="line"><a class="code" href="master_8h.xhtml#ac65bf1c69d2423b06b8c1e2d3e5286a3">uns8</a>* pSequenceBuffer = <span class="keyword">new</span> (std::nothrow) <a class="code" href="master_8h.xhtml#ac65bf1c69d2423b06b8c1e2d3e5286a3">uns8</a>[exposureBytes];</div><div class="line"><span class="keywordflow">if</span> (!pSequenceBuffer)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Unable to allocate buffer for camera %d\n&quot;</span>, ctx-&gt;hcam);</div><div class="line">    CloseAllCamerasAndUninit(contexts);</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Calculate size of each frame (needed later)</span></div><div class="line"><span class="keyword">const</span> <a class="code" href="master_8h.xhtml#ab84043a15f748ed8dfde8735af5b91d4">uns32</a> oneFrameBytes = exposureBytes / framesToAcquire;</div></div><!-- fragment --><p>Prepare the frame descriptor that will be used to extract the centroids from the image buffer. Since we know how many centroids were requested, we can pre-allocate a single descriptor and reuse it for each frame. </p><div class="fragment"><div class="line"><a class="code" href="structmd__frame.xhtml">md_frame</a>* pFrameDesc = NULL;</div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#ga69f4f47d04bf64f306439216c5875939">pl_md_create_frame_struct_cont</a>(&amp;pFrameDesc,</div><div class="line">            (<a class="code" href="master_8h.xhtml#a65d4f91467e0293f3598f24874963944">uns16</a>)desiredCentroidsCount))</div><div class="line">{</div><div class="line">    PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(),</div><div class="line">            <span class="stringliteral">&quot;pl_md_create_frame_struct_cont() error&quot;</span>);</div><div class="line">    <span class="keyword">delete</span> [] pSequenceBuffer;</div><div class="line">    CloseAllCamerasAndUninit(contexts);</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line">}</div></div><!-- fragment --><p>Start the acquisition: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#ga3f0f73b953b6c1c4eeff57e6fe165f35">pl_exp_start_seq</a>(ctx-&gt;hcam, pSequenceBuffer))</div><div class="line">{</div><div class="line">    PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(), <span class="stringliteral">&quot;pl_exp_start_seq() error&quot;</span>);</div><div class="line">    <a class="code" href="group__grp__pm__functions.xhtml#gafe119fcb9464ba56e48c4be2d49ebc49">pl_md_release_frame_struct</a>(pFrameDesc);</div><div class="line">    <span class="keyword">delete</span> [] pSequenceBuffer;</div><div class="line">    CloseAllCamerasAndUninit(contexts);</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line">}</div></div><!-- fragment --><p>Acquire the desired number of frames in a loop: </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> errorOccurred = <span class="keyword">false</span>;</div><div class="line"><a class="code" href="master_8h.xhtml#ab84043a15f748ed8dfde8735af5b91d4">uns32</a> framesAcquired = 0;</div><div class="line"><span class="keywordflow">while</span> (framesAcquired &lt; framesToAcquire)</div><div class="line">{</div></div><!-- fragment --><p>Here we need to wait for a frame readout notification signaled by the <code>eofEvent</code> in the <a class="el" href="_ex__common_types.xhtml#CameraContext">CameraContext</a> which is raised in the callback handler we registered. If the frame does not arrive within 5 seconds, or if the user aborts the acquisition with ctrl+c shortcut, the main <code>while</code> loop is interrupted and the acquisition is aborted. </p><div class="fragment"><div class="line">printf(<span class="stringliteral">&quot;Waiting for EOF event to occur on camera %d\n&quot;</span>, ctx-&gt;hcam);</div><div class="line"><span class="keywordflow">if</span> (!WaitForEofEvent(ctx, 5000, errorOccurred))</div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --><p>Once the frame is acquired, use the <a class="el" href="group__grp__pm__functions.xhtml#ga504a04b827f4c9d62c6379c5a6128518" title="Decodes a metadata-enabled frame buffer into provided frame descriptor structure. ...">pl_md_frame_decode</a> to decode the frame and fill in the frame descriptor with pointers to frame metadata and ROI image data. After the frame is decoded, the descriptor can be used to display information about the ROI coordinates. The descriptor can also be used to create a black-filled displayable image (using the <a class="el" href="group__grp__pm__functions.xhtml#gad1e45b68dda06693606a353ba4ca16d4" title="Optional function that recomposes a multi-ROI frame into a displayable image buffer. ">pl_md_frame_recompose</a>) or the descriptor can be processed manually by the application to only display the selected ROIs. Please, see the <a class="el" href="_ex__multiple_regions.xhtml">Multiple Regions</a> and <a class="el" href="group__grp__pm__functions.xhtml#gad1e45b68dda06693606a353ba4ca16d4" title="Optional function that recomposes a multi-ROI frame into a displayable image buffer. ">pl_md_frame_recompose</a> for more details. </p><div class="fragment"><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#ga504a04b827f4c9d62c6379c5a6128518">pl_md_frame_decode</a>(pFrameDesc, ctx-&gt;eofFrame, oneFrameBytes))</div><div class="line">    {</div><div class="line">        PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(), <span class="stringliteral">&quot;pl_md_frame_decode() error&quot;</span>);</div><div class="line">        errorOccurred = <span class="keyword">true</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    PrintMetaFrame(ctx, pFrameDesc, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    framesAcquired++;</div><div class="line">} <span class="comment">// End of while cycle</span></div></div><!-- fragment --><p>Here the <a class="el" href="group__grp__pm__functions.xhtml#ga5132404e942666bd1dfdd142ebc96cd3" title="Stops collecting data, cleans up device driver, halts camera. ">pl_exp_abort</a> is not strictly required as correctly acquired sequence does not need to be aborted. However, it is kept here for situations where the acquisition is interrupted by the user or when it unexpectedly times out. Please, refer to the <a class="el" href="_ex__common_functions.xhtml#secExUninit">Closing Camera and Uninitializing PVCAM</a> section for more details. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#ga5132404e942666bd1dfdd142ebc96cd3">pl_exp_abort</a>(ctx-&gt;hcam, <a class="code" href="pvcam_8h.xhtml#ab7a1073245911a408788837e797d2feca09e42992f69007857cc882f38747100c">CCS_HALT</a>))</div><div class="line">    PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(), <span class="stringliteral">&quot;pl_exp_abort() error&quot;</span>);</div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#gaf427e2f2679d268c8bda4cd653d0665f">pl_exp_finish_seq</a>(ctx-&gt;hcam, pSequenceBuffer, 0))</div><div class="line">    PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(), <span class="stringliteral">&quot;pl_exp_finish_seq() error&quot;</span>);</div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="master_8h.xhtml#a06fc87d81c62e9abb8790b6e5713c55ba54f3c24d6077e8aecf223c089f300d5b">PV_OK</a> != <a class="code" href="group__grp__pm__functions.xhtml#gafe119fcb9464ba56e48c4be2d49ebc49">pl_md_release_frame_struct</a>(pFrameDesc))</div><div class="line">    PrintErrorMessage(<a class="code" href="group__grp__pm__functions.xhtml#gac6515369e2f1d4c940a61ba605648ee8">pl_error_code</a>(), <span class="stringliteral">&quot;pl_md_release_frame_struct() error&quot;</span>);</div><div class="line"></div><div class="line"><span class="keyword">delete</span> [] pSequenceBuffer;</div><div class="line"></div><div class="line">CloseAllCamerasAndUninit(contexts);</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (errorOccurred)</div><div class="line">    <span class="keywordflow">return</span> APP_EXIT_ERROR;</div><div class="line"><span class="keywordflow">return</span> 0;</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="_example_guides.xhtml">Code Example Guides</a></li>
    <li class="footer">
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a></li>
  </ul>
</div>
</body>
</html>
