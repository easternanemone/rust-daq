// rust-daq GUI - Data Panel Component
// Data export wizard and storage management (bd-0stf)
// Pattern: AcquisitionConfig, StorageSettings, ExportWizard

import { Button, ComboBox, GroupBox, HorizontalBox, LineEdit, ListView,
         ScrollView, VerticalBox, GridBox, ProgressIndicator, CheckBox } from "std-widgets.slint";

import { AppColors, AppFonts, AppSpacing, AppLayout } from "globals.slint";

// =============================================================================
// Data Models
// =============================================================================

export struct StorageFormat {
    id: string,        // "hdf5", "csv", "arrow", "netcdf"
    name: string,      // "HDF5", "CSV", "Apache Arrow", "NetCDF"
    extension: string, // ".h5", ".csv", ".parquet", ".nc"
    available: bool,   // Whether the format is compiled in
}

export struct AcquisitionInfo {
    acquisition-id: string,
    name: string,
    start-time: string,
    end-time: string,
    status: string,         // "running", "completed", "error"
    total-points: int,
    file-path: string,
    format: string,
    size-bytes: int,
}

export struct StorageStatus {
    enabled: bool,
    current-format: string,
    output-directory: string,
    disk-free-bytes: int,
    disk-total-bytes: int,
    active-writers: int,
}

export struct ExportRequest {
    acquisition-id: string,
    target-format: string,
    output-path: string,
    include-metadata: bool,
    compress: bool,
}

// =============================================================================
// Format Selector Component
// =============================================================================

component FormatSelector inherits Rectangle {
    in property <[StorageFormat]> formats;
    in-out property <int> selected-index: 0;

    callback format-selected(string);  // format-id

    background: AppColors.panel-bg;
    border-radius: 8px;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.sm;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;
            
            HorizontalBox {
                padding-left: AppSpacing.sm;
                padding-right: AppSpacing.sm;
                Text {
                    text: "Output Format";
                    font-weight: AppFonts.weight-bold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
            }
        }

        HorizontalBox {
            spacing: AppSpacing.sm;

            for format[idx] in formats: Rectangle {
                horizontal-stretch: 1;
                height: 60px;
                background: idx == selected-index ? AppColors.selected-bg :
                           format.available ? AppColors.sidebar-bg : AppColors.disabled-bg;
                border-radius: AppLayout.radius-md;
                border-width: idx == selected-index ? AppLayout.border-medium : AppLayout.border-thin;
                border-color: idx == selected-index ? AppColors.selected-border : AppColors.border-light;

                TouchArea {
                    enabled: format.available;
                    clicked => {
                        selected-index = idx;
                        format-selected(format.id);
                    }
                }

                VerticalBox {
                    padding: AppSpacing.sm;
                    alignment: center;

                    Text {
                        text: format.name;
                        font-weight: AppFonts.weight-semibold;
                        font-size: AppFonts.size-sm;
                        color: format.available ? AppColors.text-primary : AppColors.text-muted;
                        horizontal-alignment: center;
                    }

                    Text {
                        text: format.extension;
                        font-size: AppFonts.size-xs;
                        color: AppColors.text-secondary;
                        horizontal-alignment: center;
                    }

                    if !format.available: Text {
                        text: "Not available";
                        font-size: AppFonts.size-xs;
                        color: AppColors.error;
                        horizontal-alignment: center;
                    }
                }
            }
        }
    }
}

// =============================================================================
// Storage Status Component
// =============================================================================

component StorageStatusDisplay inherits Rectangle {
    in property <StorageStatus> status;

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.sm;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;

            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;
                
                Text {
                    text: "Storage Status";
                    font-weight: AppFonts.weight-bold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                Rectangle {
                    width: 12px;
                    height: 12px;
                    border-radius: 6px;
                    background: status.enabled ? AppColors.success : AppColors.disabled-text;
                    y: parent.height / 2 - self.height / 2;
                }

                Rectangle { width: AppSpacing.xs; }

                Text {
                    text: status.enabled ? "Enabled" : "Disabled";
                    font-size: AppFonts.size-xs;
                    color: status.enabled ? AppColors.success : AppColors.text-secondary;
                    vertical-alignment: center;
                }
            }
        }

        // Disk usage bar
        VerticalBox {
            spacing: AppSpacing.xs;

            HorizontalBox {
                Text {
                    text: "Disk Space";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-secondary;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: format-bytes(status.disk-total-bytes - status.disk-free-bytes) +
                          " / " + format-bytes(status.disk-total-bytes);
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-secondary;
                }
            }

            Rectangle {
                height: 6px;
                background: AppColors.border-light;
                border-radius: 3px;

                Rectangle {
                    width: parent.width * (1 - (status.disk-free-bytes / max(status.disk-total-bytes, 1)));
                    height: parent.height;
                    border-radius: 3px;
                    background: status.disk-free-bytes < status.disk-total-bytes * 0.1 ? AppColors.error :
                               status.disk-free-bytes < status.disk-total-bytes * 0.25 ? AppColors.warning : AppColors.success;
                }
            }
        }

        // Current settings
        GridBox {
            spacing: AppSpacing.xs;

            Row {
                Text { text: "Format:"; font-size: AppFonts.size-xs; color: AppColors.text-secondary; }
                Text { text: status.current-format; font-size: AppFonts.size-xs; font-weight: AppFonts.weight-medium; }
            }

            Row {
                Text { text: "Directory:"; font-size: AppFonts.size-xs; color: AppColors.text-secondary; }
                Text {
                    text: status.output-directory;
                    font-size: AppFonts.size-xs;
                    overflow: elide;
                    horizontal-stretch: 1;
                }
            }

            Row {
                Text { text: "Active Writers:"; font-size: AppFonts.size-xs; color: AppColors.text-secondary; }
                Text { text: "\{status.active-writers}"; font-size: AppFonts.size-xs; }
            }
        }
    }

    // Helper function to format bytes
    pure function format-bytes(bytes: int) -> string {
        if bytes < 1024 {
            return "\{bytes} B";
        } else if bytes < 1048576 {
            return "\{round(bytes / 1024)} KB";
        } else if bytes < 1073741824 {
            return "\{round(bytes / 1048576)} MB";
        } else {
            return "\{round(bytes / 1073741824 * 10) / 10} GB";
        }
    }
}

// =============================================================================
// Acquisition List Component
// =============================================================================

component AcquisitionList inherits Rectangle {
    in property <[AcquisitionInfo]> acquisitions;
    in-out property <int> selected-index: -1;

    callback acquisition-selected(string);  // acquisition-id
    callback export-clicked(string, string);  // acquisition-id, name

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.sm;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;
            
            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;
                
                Text {
                    text: "Recent Acquisitions";
                    font-weight: AppFonts.weight-bold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "(\{acquisitions.length})";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
            }
        }

        if acquisitions.length == 0: Rectangle {
            height: 60px;
            background: AppColors.sidebar-bg;
            border-radius: AppLayout.radius-sm;

            Text {
                text: "No acquisitions yet";
                color: AppColors.text-muted;
                font-size: AppFonts.size-sm;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        ScrollView {
            ListView {
                for acq[idx] in acquisitions: Rectangle {
                    height: 64px;
                    background: idx == selected-index ? AppColors.selected-bg : transparent;
                    border-radius: AppLayout.radius-sm;

                    TouchArea {
                        clicked => {
                            selected-index = idx;
                            acquisition-selected(acq.acquisition-id);
                        }
                    }

                    HorizontalBox {
                        padding: AppSpacing.sm;
                        spacing: AppSpacing.sm;

                        // Status indicator
                        Rectangle {
                            width: 8px;
                            height: 8px;
                            border-radius: 4px;
                            y: parent.height / 2 - self.height / 2;
                            background: acq.status == "running" ? AppColors.warning :
                                       acq.status == "completed" ? AppColors.success : AppColors.error;
                        }

                        VerticalBox {
                            spacing: 2px;
                            horizontal-stretch: 1;

                            Text {
                                text: acq.name;
                                font-weight: AppFonts.weight-semibold;
                                font-size: AppFonts.size-sm;
                            }

                            HorizontalBox {
                                spacing: AppSpacing.sm;

                                Text {
                                    text: acq.start-time;
                                    font-size: AppFonts.size-xs;
                                    color: AppColors.text-secondary;
                                }

                                Text {
                                    text: "\{acq.total-points} points";
                                    font-size: AppFonts.size-xs;
                                    color: AppColors.text-secondary;
                                }

                                Text {
                                    text: acq.format;
                                    font-size: AppFonts.size-xs;
                                    color: AppColors.accent-bg;
                                }
                            }

                            Text {
                                text: acq.file-path;
                                font-size: AppFonts.size-xs;
                                color: AppColors.text-muted;
                                overflow: elide;
                            }
                        }

                        if acq.status == "completed": Button {
                            text: "Export";
                            clicked => { export-clicked(acq.acquisition-id, acq.name); }
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Export Dialog Component
// =============================================================================

component ExportDialog inherits Rectangle {
    in-out property <bool> show-dialog: false;
    in property <[StorageFormat]> available-formats;
    in property <string> source-acquisition-id;
    in property <string> source-name;

    in-out property <string> output-path: "";
    in-out property <int> selected-format-index: 0;
    in-out property <bool> include-metadata: true;
    in-out property <bool> compress: false;

    callback export-requested(ExportRequest);
    callback cancel-requested();

    background: rgba(0, 0, 0, 0.5);
    opacity: show-dialog ? 1 : 0;

    if show-dialog: TouchArea {
        clicked => { cancel-requested(); }
    }

    if show-dialog: Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 480px;
        height: 400px;
        background: AppColors.panel-bg;
        border-radius: AppLayout.radius-lg;
        drop-shadow-blur: 20px;
        drop-shadow-color: rgba(0, 0, 0, 0.2);

        TouchArea {
            // Prevent clicks from closing dialog
        }

        VerticalBox {
            padding: AppSpacing.xl;
            spacing: AppSpacing.lg;

            Text {
                text: "Export Acquisition";
                font-weight: AppFonts.weight-bold;
                font-size: AppFonts.size-lg;
            }

            Text {
                text: "Source: " + source-name;
                font-size: AppFonts.size-sm;
                color: AppColors.text-secondary;
            }

            // Format selection
            VerticalBox {
                spacing: AppSpacing.sm;

                Text {
                    text: "Export Format";
                    font-size: AppFonts.size-sm;
                    color: AppColors.text-secondary;
                }

                HorizontalBox {
                    spacing: AppSpacing.sm;

                    for format[idx] in available-formats: Rectangle {
                        horizontal-stretch: 1;
                        height: 48px;
                        background: idx == selected-format-index ? AppColors.selected-bg : AppColors.sidebar-bg;
                        border-radius: AppLayout.radius-sm;
                        border-width: idx == selected-format-index ? AppLayout.border-medium : AppLayout.border-thin;
                        border-color: idx == selected-format-index ? AppColors.selected-border : AppColors.border-light;

                        TouchArea {
                            enabled: format.available;
                            clicked => { selected-format-index = idx; }
                        }

                        VerticalBox {
                            alignment: center;
                            Text {
                                text: format.name;
                                font-size: AppFonts.size-xs;
                                font-weight: AppFonts.weight-medium;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }
            }

            // Output path
            VerticalBox {
                spacing: AppSpacing.sm;

                Text {
                    text: "Output Path";
                    font-size: AppFonts.size-sm;
                    color: AppColors.text-secondary;
                }

                HorizontalBox {
                    spacing: AppSpacing.sm;

                    LineEdit {
                        horizontal-stretch: 1;
                        text <=> output-path;
                        placeholder-text: "/path/to/output.ext";
                    }

                    Button {
                        text: "Browse";
                        // Would open file dialog
                    }
                }
            }

            // Options
            HorizontalBox {
                spacing: AppSpacing.lg;

                CheckBox {
                    text: "Include metadata";
                    checked <=> include-metadata;
                }

                CheckBox {
                    text: "Compress output";
                    checked <=> compress;
                }
            }

            Rectangle { vertical-stretch: 1; }

            // Buttons
            HorizontalBox {
                spacing: AppSpacing.md;
                Rectangle { horizontal-stretch: 1; }

                Button {
                    text: "Cancel";
                    clicked => {
                        cancel-requested();
                    }
                }

                Button {
                    text: "Export";
                    primary: true;
                    enabled: output-path != "";
                    clicked => {
                        export-requested({
                            acquisition-id: source-acquisition-id,
                            target-format: available-formats[selected-format-index].id,
                            output-path: output-path,
                            include-metadata: include-metadata,
                            compress: compress,
                        });
                    }
                }
            }
        }
    }
}

// =============================================================================
// Main Data Panel
// =============================================================================

export component DataPanel inherits Rectangle {
    in property <[StorageFormat]> available-formats: [];
    in property <[AcquisitionInfo]> acquisitions: [];
    in property <StorageStatus> storage-status;
    in property <bool> connected: false;

    // Export dialog state
    property <bool> export-dialog-visible: false;
    property <string> export-source-id: "";
    property <string> export-source-name: "";

    // Callbacks for Rust handlers
    callback refresh-acquisitions();
    callback configure-storage(string, string);  // format-id, output-directory
    callback export-acquisition(ExportRequest);
    callback delete-acquisition(string);         // acquisition-id

    background: AppColors.sidebar-bg;
    border-radius: AppLayout.radius-lg;

    VerticalBox {
        padding: AppSpacing.lg;
        spacing: AppSpacing.md;

        // Header
        HorizontalBox {
            spacing: AppSpacing.md;

            Text {
                text: "Data & Export";
                font-weight: AppFonts.weight-bold;
                font-size: AppFonts.size-xl;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "Refresh";
                enabled: connected;
                clicked => { refresh-acquisitions(); }
            }
        }

        // Main content in two columns
        HorizontalBox {
            spacing: AppSpacing.md;
            vertical-stretch: 1;

            // Left column: Status and Format
            VerticalBox {
                width: 300px;
                spacing: AppSpacing.md;

                StorageStatusDisplay {
                    status: storage-status;
                }

                FormatSelector {
                    formats: available-formats;
                    format-selected(format-id) => {
                        configure-storage(format-id, storage-status.output-directory);
                    }
                }
            }

            // Right column: Acquisitions
            AcquisitionList {
                horizontal-stretch: 1;
                acquisitions: acquisitions;
                acquisition-selected(id) => {
                    // Could show details panel
                }
                export-clicked(id, name) => {
                    export-source-id = id;
                    export-source-name = name;
                    export-dialog-visible = true;
                }
            }
        }
    }

    // Export dialog overlay
    ExportDialog {
        show-dialog: export-dialog-visible;
        available-formats: available-formats;
        source-acquisition-id: export-source-id;
        source-name: export-source-name;
        width: parent.width;
        height: parent.height;

        export-requested(request) => {
            export-acquisition(request);
            export-dialog-visible = false;
        }

        cancel-requested => {
            export-dialog-visible = false;
        }
    }
}
