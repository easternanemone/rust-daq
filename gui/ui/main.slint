// rust-daq GUI - Main Application
// Modular panel-based design inspired by PyMoDAQ/DynExp/ScopeFoundry/Qudi
//
// Design Principles (bd-spt6):
// - High contrast text (dark on light) for readability
// - Larger font sizes (14px base, 16-18px headers)
// - Professional scientific instrument styling
// - Clear visual hierarchy with consistent spacing
// - Dockable-style panel organization

import { Button, ComboBox, GroupBox, HorizontalBox, LineEdit, ListView,
         ScrollView, Slider, SpinBox, StandardButton, TabWidget,
         VerticalBox, GridBox, ProgressIndicator, CheckBox } from "std-widgets.slint";

import { ToastMessage, ToastContainer, ConnectionBanner } from "toast.slint";

import { ModulesPanel, ModuleTypeInfo, ModuleInstance, ModuleRole, 
         ModuleParameter, ModuleEvent } from "modules_panel.slint";

import { PresetPanel, PresetInfo } from "preset_panel.slint";

import { ExperimentPanel, PlanTypeInfo, QueuedPlan, EngineStatusInfo, 
         DocumentInfo } from "experiment_panel.slint";

import { DataPanel, StorageFormat, AcquisitionInfo, StorageStatus,
         ExportRequest } from "data_panel.slint";

import { PluginDevicesPanel, PluginDeviceInfo, PluginUiElementInfo } from "plugin_panel.slint";

// Re-export module types for Rust bindings
export { ModuleTypeInfo, ModuleInstance, ModuleRole, ModuleParameter, ModuleEvent }
export { PresetInfo }
export { PlanTypeInfo, QueuedPlan, EngineStatusInfo, DocumentInfo }
export { StorageFormat, AcquisitionInfo, StorageStatus, ExportRequest }
export { PluginDeviceInfo, PluginUiElementInfo }

// =============================================================================
// Data Models
// =============================================================================

export struct DeviceInfo {
    id: string,
    name: string,
    driver-type: string,
    is-movable: bool,
    is-readable: bool,
    is-triggerable: bool,
    is-frame-producer: bool,
    online: bool,
    selected: bool,  // NEW: Multi-select support
    // Metadata from daemon (bd-pwjo)
    position-units: string,  // For movable devices (e.g., "degrees", "mm")
    reading-units: string,   // For readable devices (e.g., "W", "mW")
    min-position: float,
    max-position: float,
}

export struct PositionInfo {
    device-id: string,
    position: float,
    units: string,
    is-moving: bool,
}

export struct ReadingInfo {
    device-id: string,
    value: float,
    units: string,
    timestamp: string,
}

export struct ScanAxisConfig {
    device-id: string,
    start: float,
    end: float,
    points: int,
}

export struct ScanStatus {
    scan-id: string,
    state: string,
    current-point: int,
    total-points: int,
    progress: float,
}

// NEW: Selected device state for multi-panel rendering
export struct SelectedMovable {
    device-id: string,
    device-name: string,
    position: float,
    units: string,
    is-moving: bool,
    min-position: float,
    max-position: float,
}

export struct SelectedReadable {
    device-id: string,
    device-name: string,
    value: float,
    units: string,
    streaming: bool,
}

// NEW: Selected camera state for CameraPanel (bd-tm0b)
export struct SelectedCamera {
    device-id: string,
    device-name: string,
    width: int,
    height: int,
    exposure-ms: float,
    min-exposure-ms: float,
    max-exposure-ms: float,
    streaming: bool,
    frame-count: int,
}

// =============================================================================
// Connection Status Component
// =============================================================================

component ConnectionStatus inherits Rectangle {
    in property <string> server-address: "localhost:50051";
    in property <string> state: "disconnected";  // "disconnected", "connecting", "connected", "error"
    in property <string> status-text: "Disconnected";
    in property <string> error-message: "";
    in property <int> retry-count: 0;

    callback connect-clicked();
    callback disconnect-clicked();
    callback retry-clicked();

    // Derived properties for styling
    property <bool> is-connected: state == "connected";
    property <bool> is-connecting: state == "connecting";
    property <bool> is-error: state == "error";
    property <color> bg-color: is-connected ? #e8f5e9 :
                               is-connecting ? #fff3e0 :
                               is-error ? #ffebee : #f5f5f5;
    property <color> indicator-color: is-connected ? #4caf50 :
                                      is-connecting ? #ff9800 :
                                      is-error ? #f44336 : #9e9e9e;

    height: error-message != "" ? 64px : 44px;
    background: bg-color;
    border-radius: 4px;

    animate height { duration: 150ms; easing: ease-out; }

    VerticalBox {
        padding: 0;
        spacing: 0;

        // Main row
        HorizontalBox {
            padding: 8px;
            padding-left: 12px;
            spacing: 10px;

            // Status indicator with pulse animation for connecting
            Rectangle {
                width: 12px;
                height: 12px;
                border-radius: 6px;
                background: indicator-color;
                
                // Pulse animation when connecting
                opacity: is-connecting ? self.pulse-opacity : 1.0;
                property <float> pulse-opacity: 1.0;
                
                states [
                    connecting when is-connecting: {
                        pulse-opacity: 0.4;
                        in { animate pulse-opacity { duration: 600ms; easing: ease-in-out; } }
                        out { animate pulse-opacity { duration: 600ms; easing: ease-in-out; } }
                    }
                ]
            }

            // Status text
            Text {
                text: is-connecting && retry-count > 0 ? 
                      status-text + " (attempt " + retry-count + ")" : status-text;
                vertical-alignment: center;
                color: #333;
                font-weight: is-error ? 600 : 400;
            }

            Rectangle { horizontal-stretch: 1; }

            // Server address input
            LineEdit {
                width: 200px;
                text: server-address;
                enabled: !is-connected && !is-connecting;
            }

            // Connect/Disconnect button
            Button {
                text: is-connected ? "Disconnect" : 
                      is-connecting ? "Cancel" : "Connect";
                enabled: !is-connecting || is-error;
                clicked => {
                    if (is-connected) {
                        disconnect-clicked();
                    } else {
                        connect-clicked();
                    }
                }
            }

            // Retry button (only shown on error)
            if is-error: Button {
                text: "Retry";
                clicked => { retry-clicked(); }
            }
        }

        // Error message row (shown only when there's an error)
        if error-message != "": HorizontalBox {
            padding-left: 34px;
            padding-right: 12px;
            padding-bottom: 8px;

            Text {
                text: error-message;
                font-size: 11px;
                color: #c62828;
                wrap: word-wrap;
            }
        }
    }
}

// =============================================================================
// Device List Component (Multi-Select) - Professional Scientific Style
// =============================================================================

component DeviceList inherits Rectangle {
    in property <[DeviceInfo]> devices;
    in-out property <int> selected-index: -1;  // Keep for primary selection highlight

    callback device-selected(int);
    callback device-toggled(string, bool);  // NEW: device-id, is-selected

    background: AppColors.sidebar-bg;
    border-radius: 6px;
    border-width: 1px;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;

        // Header with dark background (DynExp-style)
        Rectangle {
            height: 40px;
            background: AppColors.header-bg;
            border-radius: 4px;
            
            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;
                spacing: AppSpacing.sm;
                
                Text {
                    text: "üì° Instruments";
                    font-weight: 700;
                    font-size: AppFonts.size-lg;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "(\{devices.length})";
                    font-size: AppFonts.size-base;
                    color: #aaa;
                    vertical-alignment: center;
                }
            }
        }

        // Spacer
        Rectangle { height: AppSpacing.sm; }

        ListView {
            for device[idx] in devices: Rectangle {
                height: 60px;
                background: idx == selected-index ? #d4e6f1 : 
                           device.selected ? #e8daef : transparent;
                border-radius: 6px;
                border-width: idx == selected-index ? 2px : 0px;
                border-color: AppColors.accent-bg;

                HorizontalBox {
                    padding: AppSpacing.md;
                    spacing: AppSpacing.md;

                    // Multi-select checkbox
                    CheckBox {
                        checked: device.selected;
                        toggled => {
                            device-toggled(device.id, self.checked);
                        }
                    }

                    // Online indicator (larger)
                    Rectangle {
                        width: 12px;
                        height: 12px;
                        border-radius: 6px;
                        background: device.online ? AppColors.success : #9e9e9e;
                        y: parent.height / 2 - self.height / 2;
                    }

                    // Device info (clickable for primary selection)
                    TouchArea {
                        horizontal-stretch: 1;
                        clicked => {
                            selected-index = idx;
                            device-selected(idx);
                        }

                        VerticalBox {
                            spacing: 4px;
                            Text {
                                text: device.name;
                                font-weight: 600;
                                font-size: AppFonts.size-base;
                                color: AppColors.text-primary;
                            }
                            HorizontalBox {
                                spacing: 6px;
                                Text {
                                    text: device.driver-type;
                                    font-size: AppFonts.size-sm;
                                    color: AppColors.text-secondary;
                                }
                                // Capability badges (larger, clearer)
                                if device.is-movable: Rectangle {
                                    width: 22px;
                                    height: 22px;
                                    background: #2980b9;
                                    border-radius: 4px;
                                    Text {
                                        text: "M";
                                        font-size: AppFonts.size-sm;
                                        font-weight: 700;
                                        color: white;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }
                                if device.is-readable: Rectangle {
                                    width: 22px;
                                    height: 22px;
                                    background: #e67e22;
                                    border-radius: 4px;
                                    Text {
                                        text: "R";
                                        font-size: AppFonts.size-sm;
                                        font-weight: 700;
                                        color: white;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }
                                if device.is-frame-producer: Rectangle {
                                    width: 22px;
                                    height: 22px;
                                    background: #8e44ad;
                                    border-radius: 4px;
                                    Text {
                                        text: "C";
                                        font-size: AppFonts.size-sm;
                                        font-weight: 700;
                                        color: white;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Move Panel - Stage/Rotator Control (Professional Scientific Style)
// =============================================================================

component MovePanel inherits Rectangle {
    in property <string> device-id: "";
    in property <string> device-name: "Stage";
    in property <float> current-position: 0.0;
    in property <string> units: "mm";
    in property <float> min-position: -100.0;
    in property <float> max-position: 100.0;
    in property <bool> is-moving: false;

    callback move-absolute(string, float);
    callback move-relative(string, float);
    callback stop-motion(string);
    callback home(string);

    property <float> target-position: current-position;
    property <float> jog-step: 1.0;

    background: AppColors.panel-bg;
    border-radius: 8px;
    border-width: 1px;
    border-color: AppColors.border-light;
    drop-shadow-blur: 6px;
    drop-shadow-color: #0003;

    VerticalBox {
        padding: AppSpacing.lg;
        spacing: AppSpacing.lg;

        // Header with instrument icon
        Rectangle {
            height: 44px;
            background: AppColors.header-bg;
            border-radius: 6px;
            
            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;
                
                Text {
                    text: "‚öôÔ∏è " + device-name;
                    font-weight: 700;
                    font-size: AppFonts.size-xl;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
                Rectangle { horizontal-stretch: 1; }
                if is-moving: ProgressIndicator {
                    width: 24px;
                    height: 24px;
                    indeterminate: true;
                }
            }
        }

        // Current Position Display - LARGE and prominent (PyMoDAQ-style)
        Rectangle {
            height: 80px;
            background: #1a252f;
            border-radius: 6px;

            HorizontalBox {
                padding: AppSpacing.lg;
                
                Text {
                    text: "Position";
                    vertical-alignment: center;
                    color: #8899aa;
                    font-size: AppFonts.size-base;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "\{round(current-position * 1000) / 1000}";
                    font-size: AppFonts.size-3xl;
                    font-weight: 700;
                    color: is-moving ? #3498db : #2ecc71;
                    vertical-alignment: center;
                }
                Text {
                    text: " " + units;
                    font-size: AppFonts.size-xl;
                    color: #8899aa;
                    vertical-alignment: center;
                }
            }
        }

        // Position Slider with labels
        VerticalBox {
            spacing: AppSpacing.xs;
            
            Slider {
                minimum: min-position;
                maximum: max-position;
                value <=> target-position;
                enabled: !is-moving;
            }
            
            HorizontalBox {
                Text {
                    text: "\{min-position}";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-muted;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "\{max-position}";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-muted;
                }
            }
        }

        // Target Input - clearer layout
        Rectangle {
            height: 50px;
            background: AppColors.sidebar-bg;
            border-radius: 6px;
            
            HorizontalBox {
                padding: AppSpacing.md;
                spacing: AppSpacing.md;
                
                Text {
                    text: "Target:";
                    vertical-alignment: center;
                    font-size: AppFonts.size-base;
                    font-weight: 600;
                    color: AppColors.text-primary;
                }
                SpinBox {
                    minimum: round(min-position);
                    maximum: round(max-position);
                    value: round(target-position);
                    enabled: !is-moving;
                    edited(val) => {
                        target-position = val;
                    }
                }
                Text {
                    text: units;
                    vertical-alignment: center;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-secondary;
                }
                Rectangle { horizontal-stretch: 1; }
                Button {
                    text: "‚ñ∂ Go";
                    enabled: !is-moving;
                    clicked => { move-absolute(device-id, target-position); }
                }
            }
        }

        // Jog Controls - larger buttons
        GroupBox {
            title: "Jog Controls";

            VerticalBox {
                spacing: AppSpacing.md;

                HorizontalBox {
                    spacing: AppSpacing.md;
                    Text {
                        text: "Step Size:";
                        vertical-alignment: center;
                        font-size: AppFonts.size-base;
                        color: AppColors.text-primary;
                    }
                    SpinBox {
                        minimum: 1;
                        maximum: 100;
                        value: round(jog-step);
                        edited(val) => {
                            jog-step = val;
                        }
                    }
                    Text {
                        text: units;
                        vertical-alignment: center;
                        font-size: AppFonts.size-base;
                        color: AppColors.text-secondary;
                    }
                }

                HorizontalBox {
                    spacing: AppSpacing.sm;
                    
                    Button {
                        text: "‚óÄ‚óÄ";
                        min-width: 50px;
                        enabled: !is-moving;
                        clicked => { move-relative(device-id, -jog-step * 10); }
                    }
                    Button {
                        text: "‚óÄ";
                        min-width: 50px;
                        enabled: !is-moving;
                        clicked => { move-relative(device-id, -jog-step); }
                    }
                    Button {
                        text: "‚èπ STOP";
                        min-width: 80px;
                        enabled: is-moving;
                        clicked => { stop-motion(device-id); }
                    }
                    Button {
                        text: "‚ñ∂";
                        min-width: 50px;
                        enabled: !is-moving;
                        clicked => { move-relative(device-id, jog-step); }
                    }
                    Button {
                        text: "‚ñ∂‚ñ∂";
                        min-width: 50px;
                        enabled: !is-moving;
                        clicked => { move-relative(device-id, jog-step * 10); }
                    }
                }
            }
        }

        // Home Button
        Button {
            text: "üè† Home";
            enabled: !is-moving;
            clicked => { home(device-id); }
        }
    }
}

// =============================================================================
// Viewer Panel - Power Meter / Scalar Readings (Professional Scientific Style)
// =============================================================================

component ViewerPanel inherits Rectangle {
    in property <string> device-id: "";
    in property <string> device-name: "Power Meter";
    in property <float> current-value: 0.0;
    in property <string> units: "W";
    in property <bool> streaming: false;
    in property <[float]> history;  // Recent values for sparkline

    callback start-stream(string);
    callback stop-stream(string);

    background: AppColors.panel-bg;
    border-radius: 8px;
    border-width: 1px;
    border-color: AppColors.border-light;
    drop-shadow-blur: 6px;
    drop-shadow-color: #0003;

    VerticalBox {
        padding: AppSpacing.lg;
        spacing: AppSpacing.lg;

        // Header with instrument icon
        Rectangle {
            height: 44px;
            background: AppColors.header-bg;
            border-radius: 6px;
            
            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;
                
                Text {
                    text: "üìä " + device-name;
                    font-weight: 700;
                    font-size: AppFonts.size-xl;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
                Rectangle { horizontal-stretch: 1; }
                if streaming: Rectangle {
                    width: 12px;
                    height: 12px;
                    border-radius: 6px;
                    background: AppColors.success;
                }
            }
        }

        // Value Display - LARGE digital readout style
        Rectangle {
            height: 100px;
            background: #1a252f;
            border-radius: 6px;

            VerticalBox {
                padding: AppSpacing.lg;
                alignment: center;

                Text {
                    text: format-scientific(current-value);
                    font-size: 42px;
                    font-weight: 700;
                    color: streaming ? #2ecc71 : #3498db;
                    horizontal-alignment: center;
                }
                Text {
                    text: units;
                    font-size: AppFonts.size-lg;
                    color: #8899aa;
                    horizontal-alignment: center;
                }
            }
        }

        // Sparkline visualization
        Rectangle {
            height: 70px;
            background: AppColors.sidebar-bg;
            border-radius: 6px;
            border-width: 1px;
            border-color: AppColors.border-light;

            HorizontalBox {
                padding: AppSpacing.sm;
                spacing: 2px;

                for val[idx] in history: Rectangle {
                    width: 6px;
                    background: streaming ? #27ae60 : #3498db;
                    border-radius: 2px;
                }
            }
        }

        // Stream Controls
        HorizontalBox {
            spacing: AppSpacing.md;

            Button {
                text: streaming ? "‚èπ Stop Stream" : "‚ñ∂ Start Stream";
                clicked => {
                    if (streaming) {
                        stop-stream(device-id);
                    } else {
                        start-stream(device-id);
                    }
                }
            }

            Rectangle { horizontal-stretch: 1; }

            // Status indicator
            Rectangle {
                width: 120px;
                height: 32px;
                background: streaming ? #d5f5e3 : AppColors.sidebar-bg;
                border-radius: 4px;
                
                Text {
                    text: streaming ? "‚óè LIVE" : "‚óã Idle";
                    color: streaming ? #1e8449 : AppColors.text-muted;
                    font-size: AppFonts.size-base;
                    font-weight: 600;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
    }

    // Helper function for scientific notation
    pure function format-scientific(value: float) -> string {
        if (abs(value) < 0.001 && value != 0) {
            return "\{round(value * 1000000000) / 1000} n";
        } else if (abs(value) < 1) {
            return "\{round(value * 1000000) / 1000} ¬µ";
        } else if (abs(value) < 1000) {
            return "\{round(value * 1000) / 1000}";
        } else {
            return "\{round(value / 1000 * 1000) / 1000} k";
        }
    }
}

// =============================================================================
// Camera Panel - Frame Producer Control (bd-tm0b)
// =============================================================================

component CameraPanel inherits Rectangle {
    in property <string> device-id: "";
    in property <string> device-name: "Camera";
    in property <int> width-px: 0;
    in property <int> height-px: 0;
    in property <float> exposure-ms: 100.0;
    in property <float> min-exposure-ms: 0.1;
    in property <float> max-exposure-ms: 10000.0;
    in property <bool> streaming: false;
    in property <int> frame-count: 0;
    in property <image> current-frame;  // Latest frame as Slint image

    callback set-exposure(string, float);     // device-id, exposure_ms
    callback start-stream(string);            // device-id
    callback stop-stream(string);             // device-id

    property <float> target-exposure: exposure-ms;

    background: white;
    border-radius: 8px;
    drop-shadow-blur: 4px;
    drop-shadow-color: #0002;

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        // Header
        HorizontalBox {
            Text {
                text: device-name;
                font-weight: 700;
                font-size: 16px;
            }
            Rectangle { horizontal-stretch: 1; }
            // Resolution indicator
            Text {
                text: "\{width-px}√ó\{height-px}";
                font-size: 12px;
                color: #666;
                vertical-alignment: center;
            }
            if streaming: Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: #4caf50;
            }
        }

        // Frame preview (placeholder - will show actual frame when streaming)
        Rectangle {
            height: 200px;
            background: #1a1a1a;
            border-radius: 4px;
            clip: true;

            if !streaming: VerticalBox {
                alignment: center;
                Text {
                    text: "üì∑";
                    font-size: 48px;
                    horizontal-alignment: center;
                    color: #666;
                }
                Text {
                    text: "Camera idle";
                    font-size: 12px;
                    horizontal-alignment: center;
                    color: #666;
                }
            }

            if streaming: VerticalBox {
                alignment: center;
                // Image would go here when we have frame data
                // For now, show frame count indicator
                Text {
                    text: "üé•";
                    font-size: 48px;
                    horizontal-alignment: center;
                    color: #4caf50;
                }
                Text {
                    text: "Frame #\{frame-count}";
                    font-size: 14px;
                    horizontal-alignment: center;
                    color: #4caf50;
                }
            }
        }

        // Exposure Control
        VerticalBox {
            spacing: 4px;

            HorizontalBox {
                Text {
                    text: "Exposure";
                    font-size: 12px;
                    color: #666;
                    vertical-alignment: center;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "\{round(target-exposure * 100) / 100} ms";
                    font-size: 14px;
                    font-weight: 600;
                    vertical-alignment: center;
                }
            }

            Slider {
                minimum: min-exposure-ms;
                maximum: max-exposure-ms;
                value <=> target-exposure;
                enabled: !streaming;
            }

            HorizontalBox {
                Text {
                    text: "\{min-exposure-ms} ms";
                    font-size: 10px;
                    color: #999;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "\{max-exposure-ms} ms";
                    font-size: 10px;
                    color: #999;
                }
            }
        }

        // Apply exposure button
        Button {
            text: "Apply Exposure";
            enabled: !streaming && (abs(target-exposure - exposure-ms) > 0.01);
            clicked => {
                set-exposure(device-id, target-exposure);
            }
        }

        // Stream Controls
        HorizontalBox {
            spacing: 8px;

            Button {
                text: streaming ? "Stop Stream" : "Start Stream";
                primary: !streaming;
                clicked => {
                    if (streaming) {
                        stop-stream(device-id);
                    } else {
                        start-stream(device-id);
                    }
                }
            }

            Rectangle { horizontal-stretch: 1; }

            Text {
                text: streaming ? "Streaming \{frame-count} frames" : "Idle";
                color: streaming ? #4caf50 : #666;
                vertical-alignment: center;
                font-size: 12px;
            }
        }
    }
}

// =============================================================================
// Scan Panel - Scan Configuration and Control
// =============================================================================

component ScanPanel inherits Rectangle {
    in property <[DeviceInfo]> movable-devices;
    in property <[DeviceInfo]> readable-devices;
    in property <ScanStatus> scan-status;
    in property <bool> scan-running: false;

    callback create-scan(ScanAxisConfig);
    callback start-scan();
    callback stop-scan();
    callback pause-scan();

    property <int> selected-axis-device: 0;
    property <float> scan-start: 0.0;
    property <float> scan-end: 10.0;
    property <int> scan-points: 11;

    background: white;
    border-radius: 8px;
    drop-shadow-blur: 4px;
    drop-shadow-color: #0002;

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        // Header
        Text {
            text: "Scan Configuration";
            font-weight: 700;
            font-size: 16px;
        }

        // Scan Axis Selection
        GroupBox {
            title: "Scan Axis";

            GridBox {
                spacing: 8px;

                Row {
                    Text { text: "Device:"; vertical-alignment: center; }
                    ComboBox {
                        model: ["Stage", "Rotator"];  // Would be populated from movable-devices
                        current-index <=> selected-axis-device;
                        enabled: !scan-running;
                    }
                }

                Row {
                    Text { text: "Start:"; vertical-alignment: center; }
                    SpinBox {
                        minimum: -1000;
                        maximum: 1000;
                        value: round(scan-start);
                        enabled: !scan-running;
                        edited(val) => { scan-start = val; }
                    }
                }

                Row {
                    Text { text: "End:"; vertical-alignment: center; }
                    SpinBox {
                        minimum: -1000;
                        maximum: 1000;
                        value: round(scan-end);
                        enabled: !scan-running;
                        edited(val) => { scan-end = val; }
                    }
                }

                Row {
                    Text { text: "Points:"; vertical-alignment: center; }
                    SpinBox {
                        minimum: 2;
                        maximum: 1000;
                        value: scan-points;
                        enabled: !scan-running;
                        edited(val) => { scan-points = val; }
                    }
                }
            }
        }

        // Scan Progress
        if scan-running: Rectangle {
            height: 60px;
            background: #e3f2fd;
            border-radius: 4px;

            VerticalBox {
                padding: 8px;
                spacing: 4px;

                HorizontalBox {
                    Text {
                        text: "Progress:";
                    }
                    Text {
                        text: "\{scan-status.current-point} / \{scan-status.total-points}";
                        font-weight: 600;
                    }
                    Rectangle { horizontal-stretch: 1; }
                    Text {
                        text: scan-status.state;
                        color: #2196f3;
                    }
                }

                Rectangle {
                    height: 8px;
                    background: #bbdefb;
                    border-radius: 4px;

                    Rectangle {
                        width: parent.width * scan-status.progress / 100;
                        height: parent.height;
                        background: #2196f3;
                        border-radius: 4px;
                    }
                }
            }
        }

        // Control Buttons
        HorizontalBox {
            spacing: 8px;

            Button {
                text: "Start Scan";
                enabled: !scan-running;
                clicked => {
                    create-scan({
                        device-id: "stage",
                        start: scan-start,
                        end: scan-end,
                        points: scan-points,
                    });
                    start-scan();
                }
            }

            Button {
                text: "Pause";
                enabled: scan-running;
                clicked => { pause-scan(); }
            }

            Button {
                text: "Stop";
                enabled: scan-running;
                clicked => { stop-scan(); }
            }
        }
    }
}

// =============================================================================
// Main Application Window
// =============================================================================

export component MainWindow inherits Window {
    title: "rust-daq Control";
    min-width: 1200px;
    min-height: 800px;
    background: AppColors.window-bg;

    // Connection state
    in-out property <bool> connected: false;
    in-out property <string> connection-state: "disconnected";  // "disconnected", "connecting", "connected", "error"
    in-out property <string> connection-status: "Disconnected";
    in-out property <string> server-address: "localhost:50051";
    in-out property <string> connection-error: "";
    in-out property <int> retry-count: 0;

    // Toast notifications
    in property <[ToastMessage]> toasts: [];
    callback dismiss-toast(int);
    callback show-toast(string, string, string);  // severity, title, message

    // Device data
    in-out property <[DeviceInfo]> devices: [];
    in-out property <int> selected-device-index: -1;
    
    // NEW: Multi-device support - selected devices by capability
    in property <[SelectedMovable]> selected-movables: [];
    in property <[SelectedReadable]> selected-readables: [];
    in property <[SelectedCamera]> selected-cameras: [];  // NEW: Camera devices (bd-tm0b)

    // Scan data
    in property <ScanStatus> scan-status;
    in property <bool> scan-running: false;

    // Callbacks
    callback connect(string);
    callback disconnect();
    callback retry-connection();
    callback refresh-devices();
    callback select-device(int);
    callback toggle-device(string, bool);  // NEW: device-id, is-selected
    
    // NEW: Multi-device callbacks (include device-id)
    callback move-absolute(string, float);   // device-id, position
    callback move-relative(string, float);   // device-id, delta
    callback stop-motion(string);            // device-id
    callback home-device(string);            // device-id
    callback start-stream(string);           // device-id (for readable devices)
    callback stop-stream(string);            // device-id (for readable devices)

    // Camera callbacks (bd-tm0b)
    callback set-camera-exposure(string, float);  // device-id, exposure_ms
    callback start-camera-stream(string);         // device-id
    callback stop-camera-stream(string);          // device-id

    callback create-scan(ScanAxisConfig);
    callback start-scan();
    callback stop-scan();
    callback pause-scan();

    // Module properties (bd-pplp)
    in property <[ModuleTypeInfo]> module-types: [];
    in property <[ModuleInstance]> module-instances: [];
    in property <[ModuleRole]> current-module-roles: [];
    in property <[ModuleParameter]> current-module-parameters: [];
    in property <[ModuleEvent]> current-module-events: [];
    in property <[string]> available-device-ids: [];  // For module device assignment
    in-out property <string> selected-module-id: "";
    in-out property <bool> selected-module-running: false;

    // Module callbacks (bd-pplp)
    callback list-module-types();
    callback list-modules();
    callback create-module(string);                    // type-id
    callback delete-module(string);                    // module-id
    callback configure-module(string, string, string); // module-id, param-id, value
    callback assign-device-to-module(string, string, string);  // module-id, role-id, device-id
    callback unassign-device-from-module(string, string);      // module-id, role-id
    callback start-module(string);                     // module-id
    callback pause-module(string);                     // module-id
    callback resume-module(string);                    // module-id
    callback stop-module(string);                      // module-id

    // Preset properties (bd-i1c5)
    in property <[PresetInfo]> presets: [];

    // Preset callbacks (bd-i1c5)
    callback list-presets();
    callback save-preset(string, string);  // name, description
    callback load-preset(string);          // preset-id
    callback delete-preset(string);        // preset-id

    // Experiment properties (bd-niy4)
    in property <[PlanTypeInfo]> plan-types: [];
    in property <[QueuedPlan]> queued-plans: [];
    in property <EngineStatusInfo> engine-status;
    in property <[DocumentInfo]> documents: [];

    // Experiment callbacks (bd-niy4)
    callback list-plan-types();
    callback queue-plan(string);           // type-id
    callback start-engine();
    callback pause-engine();
    callback resume-engine();
    callback abort-plan(string);           // run-uid
    callback halt-engine();
    callback get-engine-status();

    // Data/Storage properties (bd-0stf)
    in property <[StorageFormat]> storage-formats: [];
    in property <[AcquisitionInfo]> acquisitions: [];
    in property <StorageStatus> storage-status;

    // Data/Storage callbacks (bd-0stf)
    callback refresh-acquisitions();
    callback configure-storage(string, string);  // format-id, output-directory
    callback export-acquisition(ExportRequest);
    callback delete-acquisition(string);         // acquisition-id

    // Plugin properties (bd-22si.6.2)
    in property <[PluginDeviceInfo]> plugin-devices: [];

    // Plugin callbacks (bd-22si.6.2)
    callback refresh-plugins();
    callback plugin-slider-changed(string, string, float);    // device-id, target, value
    callback plugin-readout-refresh(string, string);          // device-id, source
    callback plugin-toggle-changed(string, string, bool);     // device-id, target, is-on
    callback plugin-action-triggered(string, string);         // device-id, action
    callback plugin-dropdown-changed(string, string, string); // device-id, target, value

    VerticalBox {
        padding: 16px;
        spacing: 16px;

        // Connection Status Bar
        ConnectionStatus {
            server-address: root.server-address;
            state: root.connection-state;
            status-text: root.connection-status;
            error-message: root.connection-error;
            retry-count: root.retry-count;
            connect-clicked => { root.connect(server-address); }
            disconnect-clicked => { root.disconnect(); }
            retry-clicked => { root.retry-connection(); }
        }

        // Main Content Area
        HorizontalBox {
            spacing: 16px;

            // Left Sidebar - Device List
            DeviceList {
                width: 250px;
                devices: root.devices;
                selected-index <=> root.selected-device-index;
                device-selected(idx) => {
                    root.select-device(idx);
                }
                device-toggled(device-id, selected) => {
                    root.toggle-device(device-id, selected);
                }
            }

            // Main Panel Area - Tabbed Interface
            TabWidget {
                horizontal-stretch: 1;

                Tab {
                    title: "Move (\{root.selected-movables.length})";
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 16px;
                            padding: 8px;
                            
                            if root.selected-movables.length == 0: Rectangle {
                                height: 200px;
                                background: #fafafa;
                                border-radius: 8px;
                                
                                VerticalBox {
                                    alignment: center;
                                    Text {
                                        text: "No movable devices selected";
                                        font-size: 14px;
                                        color: #666;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: "Select devices with [M] badge in the list";
                                        font-size: 12px;
                                        color: #999;
                                        horizontal-alignment: center;
                                    }
                                }
                            }
                            
                            for movable in root.selected-movables: MovePanel {
                                device-id: movable.device-id;
                                device-name: movable.device-name;
                                current-position: movable.position;
                                units: movable.units;
                                min-position: movable.min-position;
                                max-position: movable.max-position;
                                is-moving: movable.is-moving;
                                move-absolute(id, pos) => { root.move-absolute(id, pos); }
                                move-relative(id, delta) => { root.move-relative(id, delta); }
                                stop-motion(id) => { root.stop-motion(id); }
                                home(id) => { root.home-device(id); }
                            }
                        }
                    }
                }

                Tab {
                    title: "Viewer (\{root.selected-readables.length})";
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 16px;
                            padding: 8px;
                            
                            if root.selected-readables.length == 0: Rectangle {
                                height: 200px;
                                background: #fafafa;
                                border-radius: 8px;
                                
                                VerticalBox {
                                    alignment: center;
                                    Text {
                                        text: "No readable devices selected";
                                        font-size: 14px;
                                        color: #666;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: "Select devices with [R] badge in the list";
                                        font-size: 12px;
                                        color: #999;
                                        horizontal-alignment: center;
                                    }
                                }
                            }
                            
                            for readable in root.selected-readables: ViewerPanel {
                                device-id: readable.device-id;
                                device-name: readable.device-name;
                                current-value: readable.value;
                                units: readable.units;
                                streaming: readable.streaming;
                                start-stream(id) => { root.start-stream(id); }
                                stop-stream(id) => { root.stop-stream(id); }
                            }
                        }
                    }
                }

                // Camera Tab (bd-tm0b)
                Tab {
                    title: "Camera (\{root.selected-cameras.length})";

                    ScrollView {
                        VerticalBox {
                            spacing: 16px;
                            padding: 8px;

                            if root.selected-cameras.length == 0: Rectangle {
                                height: 200px;
                                background: #fafafa;
                                border-radius: 8px;

                                VerticalBox {
                                    alignment: center;
                                    Text {
                                        text: "No camera devices selected";
                                        font-size: 14px;
                                        color: #666;
                                        horizontal-alignment: center;
                                    }
                                    Text {
                                        text: "Select devices with [F] badge in the list";
                                        font-size: 12px;
                                        color: #999;
                                        horizontal-alignment: center;
                                    }
                                }
                            }

                            for camera in root.selected-cameras: CameraPanel {
                                device-id: camera.device-id;
                                device-name: camera.device-name;
                                width-px: camera.width;
                                height-px: camera.height;
                                exposure-ms: camera.exposure-ms;
                                min-exposure-ms: camera.min-exposure-ms;
                                max-exposure-ms: camera.max-exposure-ms;
                                streaming: camera.streaming;
                                frame-count: camera.frame-count;
                                set-exposure(id, exp) => { root.set-camera-exposure(id, exp); }
                                start-stream(id) => { root.start-camera-stream(id); }
                                stop-stream(id) => { root.stop-camera-stream(id); }
                            }
                        }
                    }
                }

                Tab {
                    title: "Scan";
                    ScanPanel {
                        scan-status: root.scan-status;
                        scan-running: root.scan-running;
                        create-scan(config) => { root.create-scan(config); }
                        start-scan => { root.start-scan(); }
                        stop-scan => { root.stop-scan(); }
                        pause-scan => { root.pause-scan(); }
                    }
                }

                // Modules Tab (bd-pplp)
                Tab {
                    title: "Modules";
                    ModulesPanel {
                        available-module-types: root.module-types;
                        module-instances: root.module-instances;
                        available-devices: root.available-device-ids;
                        current-module-roles: root.current-module-roles;
                        current-module-parameters: root.current-module-parameters;
                        current-module-events: root.current-module-events;
                        selected-module-id <=> root.selected-module-id;
                        selected-module-running <=> root.selected-module-running;
                        
                        list-module-types => { root.list-module-types(); }
                        list-modules => { root.list-modules(); }
                        create-module(type-id) => { root.create-module(type-id); }
                        delete-module(module-id) => { root.delete-module(module-id); }
                        configure-module(module-id, param-id, value) => { 
                            root.configure-module(module-id, param-id, value); 
                        }
                        assign-device(module-id, role-id) => {
                            // Note: device-id comes from the combo selection in the panel
                            root.assign-device-to-module(module-id, role-id, "");
                        }
                        unassign-device(module-id, role-id) => {
                            root.unassign-device-from-module(module-id, role-id);
                        }
                        start-module(module-id) => { root.start-module(module-id); }
                        pause-module(module-id) => { root.pause-module(module-id); }
                        resume-module(module-id) => { root.resume-module(module-id); }
                        stop-module(module-id) => { root.stop-module(module-id); }
                    }
                }

                // Presets Tab (bd-i1c5)
                Tab {
                    title: "Presets (\{root.presets.length})";

                    PresetPanel {
                        presets: root.presets;
                        connected: root.connected;

                        list-presets => { root.list-presets(); }
                        save-preset(name, desc) => { root.save-preset(name, desc); }
                        load-preset(preset-id) => { root.load-preset(preset-id); }
                        delete-preset(preset-id) => { root.delete-preset(preset-id); }
                    }
                }

                // Experiments Tab (bd-niy4)
                Tab {
                    title: "Experiments";

                    ExperimentPanel {
                        plan-types: root.plan-types;
                        queued-plans: root.queued-plans;
                        engine-status: root.engine-status;
                        documents: root.documents;
                        connected: root.connected;

                        list-plan-types => { root.list-plan-types(); }
                        queue-plan(type-id) => { root.queue-plan(type-id); }
                        start-engine => { root.start-engine(); }
                        pause-engine => { root.pause-engine(); }
                        resume-engine => { root.resume-engine(); }
                        abort-plan(run-uid) => { root.abort-plan(run-uid); }
                        halt-engine => { root.halt-engine(); }
                        get-engine-status => { root.get-engine-status(); }
                    }
                }

                // Data Tab (bd-0stf)
                Tab {
                    title: "Data";

                    DataPanel {
                        available-formats: root.storage-formats;
                        acquisitions: root.acquisitions;
                        storage-status: root.storage-status;
                        connected: root.connected;

                        refresh-acquisitions => { root.refresh-acquisitions(); }
                        configure-storage(format-id, dir) => { root.configure-storage(format-id, dir); }
                        export-acquisition(request) => { root.export-acquisition(request); }
                        delete-acquisition(id) => { root.delete-acquisition(id); }
                    }
                }

                // Plugins Tab (bd-22si.6.2)
                Tab {
                    title: "Plugins (\{root.plugin-devices.length})";

                    PluginDevicesPanel {
                        plugin-devices: root.plugin-devices;

                        refresh-plugins => { root.refresh-plugins(); }
                        slider-changed(dev, tgt, val) => { root.plugin-slider-changed(dev, tgt, val); }
                        readout-refresh(dev, src) => { root.plugin-readout-refresh(dev, src); }
                        toggle-changed(dev, tgt, on) => { root.plugin-toggle-changed(dev, tgt, on); }
                        action-triggered(dev, act) => { root.plugin-action-triggered(dev, act); }
                        dropdown-changed(dev, tgt, val) => { root.plugin-dropdown-changed(dev, tgt, val); }
                    }
                }
            }
        }

        // Status Bar - Professional footer
        Rectangle {
            height: 32px;
            background: AppColors.header-bg;
            border-radius: 4px;

            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;

                Text {
                    text: "üì° Instruments: \{devices.length}";
                    font-size: AppFonts.size-sm;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }

                Rectangle { width: AppSpacing.xl; }
                
                Text {
                    text: "Move: \{root.selected-movables.length} | View: \{root.selected-readables.length} | Cam: \{root.selected-cameras.length}";
                    font-size: AppFonts.size-sm;
                    color: #8899aa;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                // Connection status indicator
                Rectangle {
                    width: 140px;
                    height: 24px;
                    background: connected ? #27ae60 : #c0392b;
                    border-radius: 4px;
                    
                    Text {
                        text: connected ? "‚óè Connected" : "‚óã Disconnected";
                        font-size: AppFonts.size-sm;
                        font-weight: 600;
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }

    // Toast notifications overlay (top-right corner)
    ToastContainer {
        x: root.width - self.width - 16px;
        y: 16px;
        toasts: root.toasts;
        dismiss-toast(id) => { root.dismiss-toast(id); }
    }
}

// =============================================================================
// Global Style Constants (PyMoDAQ/DynExp-inspired)
// =============================================================================

// Colors - Professional scientific instrument palette
global AppColors {
    // Background hierarchy
    out property <color> window-bg: #e8e8e8;        // Main window
    out property <color> panel-bg: #ffffff;          // Panels
    out property <color> sidebar-bg: #f5f5f5;        // Sidebar
    out property <color> header-bg: #2c3e50;         // Dark headers
    out property <color> accent-bg: #3498db;         // Primary accent
    
    // Text colors - HIGH CONTRAST
    out property <color> text-primary: #1a1a1a;      // Almost black
    out property <color> text-secondary: #4a4a4a;    // Dark gray
    out property <color> text-muted: #6b6b6b;        // Medium gray
    out property <color> text-on-dark: #ffffff;      // White on dark
    out property <color> text-on-accent: #ffffff;    // White on accent
    
    // Status colors
    out property <color> success: #27ae60;
    out property <color> warning: #f39c12;
    out property <color> error: #e74c3c;
    out property <color> info: #3498db;
    
    // Border colors
    out property <color> border-light: #ddd;
    out property <color> border-medium: #bbb;
}

// Typography - Larger, more readable sizes
global AppFonts {
    out property <length> size-xs: 11px;
    out property <length> size-sm: 13px;
    out property <length> size-base: 14px;
    out property <length> size-lg: 16px;
    out property <length> size-xl: 18px;
    out property <length> size-2xl: 24px;
    out property <length> size-3xl: 32px;
}

// Spacing
global AppSpacing {
    out property <length> xs: 4px;
    out property <length> sm: 8px;
    out property <length> md: 12px;
    out property <length> lg: 16px;
    out property <length> xl: 24px;
}
