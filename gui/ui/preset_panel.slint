// rust-daq GUI - Preset Panel Component
// Manages experiment presets: save/load device configurations
// Pattern: Configuration snapshot management (bd-i1c5)

import { Button, ComboBox, GroupBox, HorizontalBox, LineEdit, ListView,
         ScrollView, VerticalBox, GridBox, StandardButton } from "std-widgets.slint";

import { AppColors, AppFonts, AppSpacing, AppLayout } from "globals.slint";

// =============================================================================
// Data Models
// =============================================================================

export struct PresetInfo {
    preset-id: string,
    name: string,
    description: string,
    author: string,
    created-at: string,  // Human-readable timestamp
    updated-at: string,
    device-count: int,   // Number of device configs in preset
}

// =============================================================================
// Preset List Component
// =============================================================================

component PresetList inherits Rectangle {
    in property <[PresetInfo]> presets;
    in-out property <int> selected-index: -1;

    callback preset-selected(string);  // preset-id

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.lg;
        spacing: AppSpacing.md;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;
            
            HorizontalBox {
                padding-left: AppSpacing.sm;
                padding-right: AppSpacing.sm;
                Text {
                    text: "Saved Presets";
                    font-weight: AppFonts.weight-bold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
            }
        }

        if presets.length == 0: Rectangle {
            height: 60px;
            background: AppColors.sidebar-bg;
            border-radius: AppLayout.radius-sm;

            Text {
                text: "No presets saved yet";
                color: AppColors.text-muted;
                font-size: AppFonts.size-sm;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        ScrollView {
            ListView {
                for preset[idx] in presets: Rectangle {
                    height: 72px;
                    background: idx == selected-index ? AppColors.selected-bg : transparent;
                    border-radius: AppLayout.radius-sm;

                    TouchArea {
                        clicked => {
                            selected-index = idx;
                            preset-selected(preset.preset-id);
                        }
                    }

                    VerticalBox {
                        padding: AppSpacing.md;
                        spacing: AppSpacing.xs;

                        HorizontalBox {
                            spacing: AppSpacing.md;
                            Text {
                                text: preset.name;
                                font-weight: AppFonts.weight-semibold;
                                font-size: AppFonts.size-base;
                            }
                            Rectangle { horizontal-stretch: 1; }
                            Text {
                                text: "\{preset.device-count} devices";
                                font-size: AppFonts.size-xs;
                                color: AppColors.text-secondary;
                            }
                        }

                        Text {
                            text: preset.description;
                            font-size: AppFonts.size-xs;
                            color: AppColors.text-secondary;
                            wrap: word-wrap;
                            overflow: elide;
                        }

                        HorizontalBox {
                            spacing: AppSpacing.sm;
                            Text {
                                text: "by \{preset.author}";
                                font-size: AppFonts.size-xs;
                                color: AppColors.text-muted;
                            }
                            Text {
                                text: preset.updated-at;
                                font-size: AppFonts.size-xs;
                                color: AppColors.text-muted;
                            }
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Save Preset Dialog
// =============================================================================

component SavePresetDialog inherits Rectangle {
    in-out property <bool> show-dialog: false;
    in-out property <string> preset-name: "";
    in-out property <string> preset-description: "";

    callback save-requested(string, string);  // name, description
    callback cancel-requested();

    background: rgba(0, 0, 0, 0.5);
    opacity: show-dialog ? 1 : 0;

    if show-dialog: TouchArea {
        clicked => { cancel-requested(); }
    }

    if show-dialog: Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 400px;
        height: 320px;
        background: AppColors.panel-bg;
        border-radius: AppLayout.radius-lg;
        drop-shadow-blur: 20px;
        drop-shadow-color: rgba(0, 0, 0, 0.2);

        TouchArea {
            // Prevent clicks from closing dialog
        }

        VerticalBox {
            padding: AppSpacing.xl;
            spacing: AppSpacing.lg;

            Text {
                text: "Save Preset";
                font-weight: AppFonts.weight-bold;
                font-size: AppFonts.size-lg;
            }

            VerticalBox {
                spacing: AppSpacing.sm;

                Text {
                    text: "Preset Name";
                    font-size: AppFonts.size-sm;
                    color: AppColors.text-secondary;
                }

                LineEdit {
                    text <=> preset-name;
                    placeholder-text: "e.g., Two-Photon Standard";
                }
            }

            VerticalBox {
                spacing: AppSpacing.sm;

                Text {
                    text: "Description";
                    font-size: AppFonts.size-sm;
                    color: AppColors.text-secondary;
                }

                LineEdit {
                    text <=> preset-description;
                    placeholder-text: "Optional description...";
                }
            }

            Rectangle { vertical-stretch: 1; }

            HorizontalBox {
                spacing: 12px;
                Rectangle { horizontal-stretch: 1; }

                Button {
                    text: "Cancel";
                    clicked => {
                        preset-name = "";
                        preset-description = "";
                        cancel-requested();
                    }
                }

                Button {
                    text: "Save Preset";
                    primary: true;
                    enabled: preset-name != "";
                    clicked => {
                        save-requested(preset-name, preset-description);
                        preset-name = "";
                        preset-description = "";
                    }
                }
            }
        }
    }
}

// =============================================================================
// Main Preset Panel
// =============================================================================

export component PresetPanel inherits Rectangle {
    in property <[PresetInfo]> presets: [];
    in property <bool> connected: false;

    // Selected preset state
    in-out property <string> selected-preset-id: "";

    // Dialog state
    property <bool> save-dialog-visible: false;

    // Callbacks for Rust handlers
    callback list-presets();
    callback save-preset(string, string);  // name, description
    callback load-preset(string);          // preset-id
    callback delete-preset(string);        // preset-id

    background: AppColors.sidebar-bg;
    border-radius: AppLayout.radius-lg;

    VerticalBox {
        padding: AppSpacing.xl;
        spacing: AppSpacing.lg;

        // Header
        HorizontalBox {
            spacing: AppSpacing.md;

            Text {
                text: "Presets";
                font-weight: AppFonts.weight-bold;
                font-size: AppFonts.size-xl;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "Refresh";
                enabled: connected;
                clicked => { list-presets(); }
            }

            Button {
                text: "Save Current";
                primary: true;
                enabled: connected;
                clicked => { save-dialog-visible = true; }
            }
        }

        // Preset list
        preset-list := PresetList {
            presets: root.presets;
            preset-selected(id) => {
                selected-preset-id = id;
                // Name lookup happens in the PresetList component where we have the index
            }
        }

        // Action buttons for selected preset
        if selected-preset-id != "": GroupBox {
            title: "Selected Preset";

            HorizontalBox {
                spacing: AppSpacing.md;
                padding: AppSpacing.sm;

                Button {
                    text: "Load Preset";
                    primary: true;
                    clicked => {
                        load-preset(selected-preset-id);
                    }
                }

                Button {
                    text: "Delete";
                    clicked => {
                        delete-preset(selected-preset-id);
                        selected-preset-id = "";
                        preset-list.selected-index = -1;
                    }
                }

                Rectangle { horizontal-stretch: 1; }
            }
        }
    }

    // Save dialog overlay
    SavePresetDialog {
        show-dialog: save-dialog-visible;
        width: parent.width;
        height: parent.height;

        save-requested(name, desc) => {
            save-preset(name, desc);
            save-dialog-visible = false;
        }

        cancel-requested => {
            save-dialog-visible = false;
        }
    }
}
