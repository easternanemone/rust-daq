// rust-daq GUI - Experiment Panel Component
// Bluesky-style RunEngine integration for plan execution (bd-niy4)
// Pattern: Plan queue, engine control, document streaming

import { Button, ComboBox, GroupBox, HorizontalBox, LineEdit, ListView,
         ScrollView, VerticalBox, GridBox, ProgressIndicator } from "std-widgets.slint";

// =============================================================================
// Data Models
// =============================================================================

export struct PlanTypeInfo {
    type-id: string,
    display-name: string,
    description: string,
    categories: string,  // Comma-separated
}

export struct QueuedPlan {
    run-uid: string,
    plan-type: string,
    display-name: string,
    queue-position: int,
    state: string,  // "queued", "running", "completed", "aborted"
}

export struct EngineStatusInfo {
    state: string,  // "idle", "running", "paused", "aborting", "halted"
    current-run-uid: string,
    current-plan-type: string,
    current-event: int,
    total-events: int,
    queued-plans: int,
    elapsed-seconds: float,
}

export struct DocumentInfo {
    doc-type: string,  // "start", "descriptor", "event", "stop"
    uid: string,
    timestamp: string,
    summary: string,
}

// =============================================================================
// Plan Type Browser
// =============================================================================

component PlanTypeBrowser inherits Rectangle {
    in property <[PlanTypeInfo]> plan-types;
    in-out property <int> selected-index: -1;

    callback plan-type-selected(string);  // type-id

    background: white;
    border-radius: 8px;

    VerticalBox {
        padding: 12px;
        spacing: 8px;

        Text {
            text: "Available Plans";
            font-weight: 700;
            font-size: 13px;
        }

        if plan-types.length == 0: Rectangle {
            height: 40px;
            background: #f5f5f5;
            border-radius: 4px;

            Text {
                text: "No plans available";
                color: #999;
                font-size: 11px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        ScrollView {
            ListView {
                for plan[idx] in plan-types: Rectangle {
                    height: 56px;
                    background: idx == selected-index ? #e3f2fd : transparent;
                    border-radius: 4px;

                    TouchArea {
                        clicked => {
                            selected-index = idx;
                            plan-type-selected(plan.type-id);
                        }
                    }

                    VerticalBox {
                        padding: 8px;
                        spacing: 2px;

                        Text {
                            text: plan.display-name;
                            font-weight: 600;
                            font-size: 12px;
                        }

                        Text {
                            text: plan.description;
                            font-size: 10px;
                            color: #666;
                            overflow: elide;
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Plan Queue Display
// =============================================================================

component PlanQueue inherits Rectangle {
    in property <[QueuedPlan]> queued-plans;
    in property <string> current-run-uid;

    callback abort-plan(string);  // run-uid

    background: white;
    border-radius: 8px;

    VerticalBox {
        padding: 12px;
        spacing: 8px;

        Text {
            text: "Plan Queue (\{queued-plans.length})";
            font-weight: 700;
            font-size: 13px;
        }

        if queued-plans.length == 0: Rectangle {
            height: 40px;
            background: #f5f5f5;
            border-radius: 4px;

            Text {
                text: "Queue empty";
                color: #999;
                font-size: 11px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        ScrollView {
            ListView {
                for plan in queued-plans: Rectangle {
                    height: 48px;
                    background: plan.run-uid == current-run-uid ? #fff3e0 :
                               plan.state == "completed" ? #e8f5e9 :
                               plan.state == "aborted" ? #ffebee : white;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: #e0e0e0;

                    HorizontalBox {
                        padding: 8px;
                        spacing: 8px;

                        // Status indicator
                        Rectangle {
                            width: 8px;
                            height: 8px;
                            border-radius: 4px;
                            background: plan.state == "running" ? #ff9800 :
                                       plan.state == "completed" ? #4caf50 :
                                       plan.state == "aborted" ? #f44336 : #9e9e9e;
                        }

                        VerticalBox {
                            spacing: 2px;
                            horizontal-stretch: 1;

                            Text {
                                text: plan.display-name;
                                font-weight: 500;
                                font-size: 11px;
                            }

                            Text {
                                text: "UID: " + plan.run-uid;
                                font-size: 9px;
                                color: #999;
                                overflow: elide;
                            }
                        }

                        if plan.state == "queued" || plan.state == "running": Button {
                            text: "Abort";
                            clicked => { abort-plan(plan.run-uid); }
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Engine Controls
// =============================================================================

component EngineControls inherits Rectangle {
    in property <EngineStatusInfo> status;
    in property <bool> connected;

    callback start-engine();
    callback pause-engine();
    callback resume-engine();
    callback halt-engine();

    background: white;
    border-radius: 8px;

    VerticalBox {
        padding: 12px;
        spacing: 12px;

        // Status display
        HorizontalBox {
            spacing: 8px;

            Rectangle {
                width: 12px;
                height: 12px;
                border-radius: 6px;
                background: status.state == "running" ? #4caf50 :
                           status.state == "paused" ? #ff9800 :
                           status.state == "halted" ? #f44336 : #9e9e9e;
            }

            Text {
                text: status.state == "idle" ? "Engine Idle" :
                      status.state == "running" ? "Running" :
                      status.state == "paused" ? "Paused" :
                      status.state == "aborting" ? "Aborting..." :
                      status.state == "halted" ? "HALTED" : "Unknown";
                font-weight: 600;
                font-size: 14px;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            if status.queued-plans > 0: Text {
                text: "\{status.queued-plans} queued";
                font-size: 11px;
                color: #666;
                vertical-alignment: center;
            }
        }

        // Progress display (when running)
        if status.state == "running" && status.total-events > 0: VerticalBox {
            spacing: 4px;

            HorizontalBox {
                Text {
                    text: "Event \{status.current-event} / \{status.total-events}";
                    font-size: 11px;
                    color: #666;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "\{status.elapsed-seconds}s";
                    font-size: 11px;
                    color: #666;
                }
            }

            ProgressIndicator {
                height: 4px;
                progress: status.total-events > 0 ?
                    (status.current-event / status.total-events) : 0;
            }
        }

        // Control buttons
        HorizontalBox {
            spacing: 8px;

            Button {
                text: "Start";
                primary: true;
                enabled: connected && (status.state == "idle" || status.queued-plans > 0);
                clicked => { start-engine(); }
            }

            Button {
                text: status.state == "paused" ? "Resume" : "Pause";
                enabled: connected && (status.state == "running" || status.state == "paused");
                clicked => {
                    if status.state == "paused" {
                        resume-engine();
                    } else {
                        pause-engine();
                    }
                }
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "HALT";
                enabled: connected && status.state != "idle" && status.state != "halted";
                clicked => { halt-engine(); }
            }
        }
    }
}

// =============================================================================
// Document Stream Viewer
// =============================================================================

component DocumentStream inherits Rectangle {
    in property <[DocumentInfo]> documents;

    background: white;
    border-radius: 8px;

    VerticalBox {
        padding: 12px;
        spacing: 8px;

        Text {
            text: "Document Stream (\{documents.length})";
            font-weight: 700;
            font-size: 13px;
        }

        ScrollView {
            ListView {
                for doc in documents: Rectangle {
                    height: 36px;
                    background: transparent;

                    HorizontalBox {
                        padding: 6px;
                        spacing: 8px;

                        // Doc type badge
                        Rectangle {
                            width: 60px;
                            height: 20px;
                            border-radius: 4px;
                            background: doc.doc-type == "start" ? #e3f2fd :
                                       doc.doc-type == "descriptor" ? #f3e5f5 :
                                       doc.doc-type == "event" ? #e8f5e9 :
                                       doc.doc-type == "stop" ? #fff3e0 : #f5f5f5;

                            Text {
                                text: doc.doc-type;
                                font-size: 9px;
                                font-weight: 500;
                                color: doc.doc-type == "start" ? #1976d2 :
                                       doc.doc-type == "descriptor" ? #7b1fa2 :
                                       doc.doc-type == "event" ? #388e3c :
                                       doc.doc-type == "stop" ? #f57c00 : #666;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        Text {
                            text: doc.summary;
                            font-size: 11px;
                            color: #333;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                            overflow: elide;
                        }

                        Text {
                            text: doc.timestamp;
                            font-size: 9px;
                            color: #999;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Main Experiment Panel
// =============================================================================

export component ExperimentPanel inherits Rectangle {
    in property <[PlanTypeInfo]> plan-types: [];
    in property <[QueuedPlan]> queued-plans: [];
    in property <EngineStatusInfo> engine-status;
    in property <[DocumentInfo]> documents: [];
    in property <bool> connected: false;

    // Callbacks for Rust handlers
    callback list-plan-types();
    callback queue-plan(string);  // type-id (simplified - full params would be more complex)
    callback start-engine();
    callback pause-engine();
    callback resume-engine();
    callback abort-plan(string);  // run-uid
    callback halt-engine();
    callback get-engine-status();

    background: #f8f9fa;
    border-radius: 12px;

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        // Header
        HorizontalBox {
            spacing: 12px;

            Text {
                text: "Experiments";
                font-weight: 700;
                font-size: 18px;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "Refresh";
                enabled: connected;
                clicked => {
                    list-plan-types();
                    get-engine-status();
                }
            }
        }

        // Engine controls at top
        EngineControls {
            status: engine-status;
            connected: connected;
            start-engine => { root.start-engine(); }
            pause-engine => { root.pause-engine(); }
            resume-engine => { root.resume-engine(); }
            halt-engine => { root.halt-engine(); }
        }

        // Main content area
        HorizontalBox {
            spacing: 12px;
            vertical-stretch: 1;

            // Left: Plan types and queue
            VerticalBox {
                width: 280px;
                spacing: 12px;

                PlanTypeBrowser {
                    plan-types: root.plan-types;
                    vertical-stretch: 1;
                    plan-type-selected(type-id) => {
                        root.queue-plan(type-id);
                    }
                }

                PlanQueue {
                    height: 200px;
                    queued-plans: root.queued-plans;
                    current-run-uid: engine-status.current-run-uid;
                    abort-plan(uid) => { root.abort-plan(uid); }
                }
            }

            // Right: Document stream
            DocumentStream {
                documents: root.documents;
                horizontal-stretch: 1;
            }
        }
    }
}
