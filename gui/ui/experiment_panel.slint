// rust-daq GUI - Experiment Panel Component
// Bluesky-style RunEngine integration for plan execution (bd-niy4)
// Pattern: Plan queue, engine control, document streaming

import { Button, ComboBox, GroupBox, HorizontalBox, LineEdit, ListView,
         ScrollView, VerticalBox, GridBox, ProgressIndicator } from "std-widgets.slint";

import { AppColors, AppFonts, AppSpacing, AppLayout } from "globals.slint";

// =============================================================================
// Data Models
// =============================================================================

export struct PlanTypeInfo {
    type-id: string,
    display-name: string,
    description: string,
    categories: string,  // Comma-separated
}

export struct QueuedPlan {
    run-uid: string,
    plan-type: string,
    display-name: string,
    queue-position: int,
    state: string,  // "queued", "running", "completed", "aborted"
}

export struct EngineStatusInfo {
    state: string,  // "idle", "running", "paused", "aborting", "halted"
    current-run-uid: string,
    current-plan-type: string,
    current-event: int,
    total-events: int,
    queued-plans: int,
    elapsed-seconds: float,
}

export struct DocumentInfo {
    doc-type: string,  // "start", "descriptor", "event", "stop"
    uid: string,
    timestamp: string,
    summary: string,
}

// =============================================================================
// Plan Type Browser
// =============================================================================

component PlanTypeBrowser inherits Rectangle {
    in property <[PlanTypeInfo]> plan-types;
    in-out property <int> selected-index: -1;

    callback plan-type-selected(string);  // type-id

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.sm;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;
            
            Text {
                text: "Available Plans";
                font-weight: AppFonts.weight-bold;
                font-size: AppFonts.size-base;
                color: AppColors.text-on-dark;
                x: AppSpacing.sm;
                vertical-alignment: center;
            }
        }

        if plan-types.length == 0: Rectangle {
            height: 40px;
            background: AppColors.sidebar-bg;
            border-radius: AppLayout.radius-sm;

            Text {
                text: "No plans available";
                color: AppColors.text-muted;
                font-size: AppFonts.size-xs;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        if plan-types.length > 0: ScrollView {
            ListView {
                for plan[idx] in plan-types: Rectangle {
                    height: 56px;
                    background: idx == selected-index ? AppColors.selected-bg : transparent;
                    border-radius: AppLayout.radius-sm;
                    border-width: idx == selected-index ? AppLayout.border-thin : 0px;
                    border-color: AppColors.selected-border;

                    TouchArea {
                        clicked => {
                            selected-index = idx;
                            plan-type-selected(plan.type-id);
                        }
                    }

                    VerticalBox {
                        padding: AppSpacing.sm;
                        spacing: 2px;

                        Text {
                            text: plan.display-name;
                            font-weight: AppFonts.weight-semibold;
                            font-size: AppFonts.size-sm;
                            color: AppColors.text-primary;
                        }

                        Text {
                            text: plan.description;
                            font-size: AppFonts.size-xs;
                            color: AppColors.text-secondary;
                            overflow: elide;
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Plan Queue Display
// =============================================================================

component PlanQueue inherits Rectangle {
    in property <[QueuedPlan]> queued-plans;
    in property <string> current-run-uid;

    callback abort-plan(string);  // run-uid

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.sm;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;

            HorizontalBox {
                padding-left: AppSpacing.sm;
                padding-right: AppSpacing.sm;
                Text {
                    text: "Plan Queue (\{queued-plans.length})";
                    font-weight: AppFonts.weight-bold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
            }
        }

        if queued-plans.length == 0: Rectangle {
            height: 40px;
            background: AppColors.sidebar-bg;
            border-radius: AppLayout.radius-sm;

            Text {
                text: "Queue empty";
                color: AppColors.text-muted;
                font-size: AppFonts.size-xs;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        ScrollView {
            ListView {
                for plan in queued-plans: Rectangle {
                    height: 48px;
                    background: plan.run-uid == current-run-uid ? AppColors.bg-warning :
                               plan.state == "completed" ? AppColors.bg-success :
                               plan.state == "aborted" ? AppColors.bg-error : AppColors.panel-bg;
                    border-radius: AppLayout.radius-sm;
                    border-width: AppLayout.border-thin;
                    border-color: AppColors.border-light;

                    HorizontalBox {
                        padding: AppSpacing.sm;
                        spacing: AppSpacing.sm;

                        // Status indicator
                        Rectangle {
                            width: 8px;
                            height: 8px;
                            border-radius: 4px;
                            background: plan.state == "running" ? AppColors.warning :
                                       plan.state == "completed" ? AppColors.success :
                                       plan.state == "aborted" ? AppColors.error : AppColors.disabled-text;
                        }

                        VerticalBox {
                            spacing: 2px;
                            horizontal-stretch: 1;

                            Text {
                                text: plan.display-name;
                                font-weight: AppFonts.weight-medium;
                                font-size: AppFonts.size-xs;
                                color: AppColors.text-primary;
                            }

                            Text {
                                text: "UID: " + plan.run-uid;
                                font-size: AppFonts.size-xs;
                                color: AppColors.text-muted;
                                overflow: elide;
                            }
                        }

                        if plan.state == "queued" || plan.state == "running": Button {
                            text: "Abort";
                            clicked => { abort-plan(plan.run-uid); }
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Engine Controls
// =============================================================================

component EngineControls inherits Rectangle {
    in property <EngineStatusInfo> status;
    in property <bool> connected;

    callback start-engine();
    callback pause-engine();
    callback resume-engine();
    callback halt-engine();

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.md;

        // Status display
        Rectangle {
            height: 40px;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;
            
            HorizontalBox {
                padding-left: AppSpacing.md;
                padding-right: AppSpacing.md;
                spacing: AppSpacing.sm;

                Rectangle {
                    width: 12px;
                    height: 12px;
                    border-radius: 6px;
                    background: status.state == "running" ? AppColors.success :
                               status.state == "paused" ? AppColors.warning :
                               status.state == "halted" ? AppColors.error : AppColors.disabled-text;
                    y: parent.height / 2 - self.height / 2;
                }

                Text {
                    text: status.state == "idle" ? "Engine Idle" :
                          status.state == "running" ? "Running" :
                          status.state == "paused" ? "Paused" :
                          status.state == "aborting" ? "Aborting..." :
                          status.state == "halted" ? "HALTED" : "Unknown";
                    font-weight: AppFonts.weight-semibold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                if status.queued-plans > 0: Text {
                    text: "\{status.queued-plans} queued";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
            }
        }

        // Progress display (when running)
        if status.state == "running" && status.total-events > 0: VerticalBox {
            spacing: AppSpacing.xs;

            HorizontalBox {
                Text {
                    text: "Event \{status.current-event} / \{status.total-events}";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-secondary;
                }
                Rectangle { horizontal-stretch: 1; }
                Text {
                    text: "\{status.elapsed-seconds}s";
                    font-size: AppFonts.size-xs;
                    color: AppColors.text-secondary;
                }
            }

            ProgressIndicator {
                height: 4px;
                progress: status.total-events > 0 ?
                    (status.current-event / status.total-events) : 0;
            }
        }

        // Control buttons
        HorizontalBox {
            spacing: AppSpacing.sm;

            Button {
                text: "Start";
                primary: true;
                enabled: connected && (status.state == "idle" || status.queued-plans > 0);
                clicked => { start-engine(); }
            }

            Button {
                text: status.state == "paused" ? "Resume" : "Pause";
                enabled: connected && (status.state == "running" || status.state == "paused");
                clicked => {
                    if status.state == "paused" {
                        resume-engine();
                    } else {
                        pause-engine();
                    }
                }
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "HALT";
                enabled: connected && status.state != "idle" && status.state != "halted";
                clicked => { halt-engine(); }
            }
        }
    }
}

// =============================================================================
// Document Stream Viewer
// =============================================================================

component DocumentStream inherits Rectangle {
    in property <[DocumentInfo]> documents;

    background: AppColors.panel-bg;
    border-radius: AppLayout.radius-md;
    border-width: AppLayout.border-thin;
    border-color: AppColors.border-light;

    VerticalBox {
        padding: AppSpacing.md;
        spacing: AppSpacing.sm;

        Rectangle {
            height: AppLayout.header-height;
            background: AppColors.header-bg;
            border-radius: AppLayout.radius-sm;
            
            HorizontalBox {
                padding-left: AppSpacing.sm;
                padding-right: AppSpacing.sm;
                Text {
                    text: "Document Stream (\{documents.length})";
                    font-weight: AppFonts.weight-bold;
                    font-size: AppFonts.size-base;
                    color: AppColors.text-on-dark;
                    vertical-alignment: center;
                }
            }
        }

        ScrollView {
            ListView {
                for doc in documents: Rectangle {
                    height: 36px;
                    background: transparent;

                    HorizontalBox {
                        padding: 6px;
                        spacing: AppSpacing.sm;

                        // Doc type badge
                        Rectangle {
                            width: 60px;
                            height: 20px;
                            border-radius: AppLayout.radius-sm;
                            background: doc.doc-type == "start" ? AppColors.bg-info :
                                       doc.doc-type == "descriptor" ? #f3e5f5 :
                                       doc.doc-type == "event" ? AppColors.bg-success :
                                       doc.doc-type == "stop" ? AppColors.bg-warning : AppColors.sidebar-bg;

                            Text {
                                text: doc.doc-type;
                                font-size: AppFonts.size-xs;
                                font-weight: AppFonts.weight-medium;
                                color: doc.doc-type == "start" ? #1976d2 :
                                       doc.doc-type == "descriptor" ? #7b1fa2 :
                                       doc.doc-type == "event" ? #388e3c :
                                       doc.doc-type == "stop" ? #f57c00 : AppColors.text-secondary;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        Text {
                            text: doc.summary;
                            font-size: AppFonts.size-xs;
                            color: AppColors.text-primary;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                            overflow: elide;
                        }

                        Text {
                            text: doc.timestamp;
                            font-size: AppFonts.size-xs;
                            color: AppColors.text-muted;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}

// =============================================================================
// Main Experiment Panel
// =============================================================================

export component ExperimentPanel inherits Rectangle {
    in property <[PlanTypeInfo]> plan-types: [];
    in property <[QueuedPlan]> queued-plans: [];
    in property <EngineStatusInfo> engine-status;
    in property <[DocumentInfo]> documents: [];
    in property <bool> connected: false;

    // Callbacks for Rust handlers
    callback list-plan-types();
    callback queue-plan(string);  // type-id (simplified - full params would be more complex)
    callback start-engine();
    callback pause-engine();
    callback resume-engine();
    callback abort-plan(string);  // run-uid
    callback halt-engine();
    callback get-engine-status();

    background: AppColors.sidebar-bg;
    border-radius: AppLayout.radius-lg;

    VerticalBox {
        padding: AppSpacing.lg;
        spacing: AppSpacing.md;

        // Header
        HorizontalBox {
            spacing: AppSpacing.md;

            Text {
                text: "Experiments";
                font-weight: AppFonts.weight-bold;
                font-size: AppFonts.size-xl;
                vertical-alignment: center;
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "Refresh";
                enabled: connected;
                clicked => {
                    list-plan-types();
                    get-engine-status();
                }
            }
        }

        // Engine controls at top
        EngineControls {
            status: engine-status;
            connected: connected;
            start-engine => { root.start-engine(); }
            pause-engine => { root.pause-engine(); }
            resume-engine => { root.resume-engine(); }
            halt-engine => { root.halt-engine(); }
        }

        // Main content area
        HorizontalBox {
            spacing: 12px;
            vertical-stretch: 1;

            // Left: Plan types and queue
            VerticalBox {
                width: 280px;
                spacing: 12px;

                PlanTypeBrowser {
                    plan-types: root.plan-types;
                    vertical-stretch: 1;
                    plan-type-selected(type-id) => {
                        root.queue-plan(type-id);
                    }
                }

                PlanQueue {
                    height: 200px;
                    queued-plans: root.queued-plans;
                    current-run-uid: engine-status.current-run-uid;
                    abort-plan(uid) => { root.abort-plan(uid); }
                }
            }

            // Right: Document stream
            DocumentStream {
                documents: root.documents;
                horizontal-stretch: 1;
            }
        }
    }
}
