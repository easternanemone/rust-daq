# Default configuration for Rust DAQ application

# Log level: "error", "warn", "info", "debug", "trace"
log_level = "info"

[application]
# Channel capacities for data distribution
# Broadcast channel distributes data from instruments to GUI and storage
# Command channel sends control commands to instrument tasks
broadcast_channel_capacity = 1024  # Messages buffered in broadcast channel
command_channel_capacity = 32      # Commands buffered per instrument

[application.timeouts]
# Serial I/O timeouts (milliseconds)
# Applied to serial port read/write operations for all serial instruments
# Typical range: 1000-5000ms (slower instruments need longer timeouts)
# Valid range: 100-30000ms
serial_read_timeout_ms = 1000
serial_write_timeout_ms = 1000

# Protocol timeouts (milliseconds)
# Applied to SCPI command/response cycles
# Increase for instruments with long processing times
# Valid range: 500-60000ms
scpi_command_timeout_ms = 2000

# Network timeouts (milliseconds)
# Applied to network client operations and cleanup
# Valid range: 1000-120000ms
network_client_timeout_ms = 5000
network_cleanup_timeout_ms = 10000

# Instrument lifecycle timeouts (milliseconds)
# Applied to connection, shutdown, and measurement operations
# Increase for instruments with slow initialization or shutdown
# Valid range: 1000-60000ms
instrument_connect_timeout_ms = 5000
instrument_shutdown_timeout_ms = 6000
instrument_measurement_timeout_ms = 5000

[application.data_distributor]
# Per-subscriber channel capacity and observability thresholds
subscriber_capacity = 1024
warn_drop_rate_percent = 1.0
error_saturation_percent = 90.0
metrics_window_secs = 10

[storage]
default_path = "data_output"
default_format = "csv" # "csv", "hdf5", "arrow"

# Configuration for specific instruments
[instruments]

[instruments.mock]
type = "mock"
name = "Mock Instrument"
sample_rate_hz = 1000.0 # Increased for faster testing
num_samples = 4096      # Enough for multiple FFT windows
channels = ["sine_wave", "cosine_wave"]

[instruments.scpi_keithley]
type = "scpi_keithley"
name = "Keithley 2400 (SCPI)"
# Example for a serial-based SCPI device
# port = "/dev/ttyUSB0"
# baud_rate = 9600
# Example for a network-based SCPI device
address = "192.168.1.102"
port = 5025

[instruments.maitai]
type = "maitai"
name = "MaiTai Ti:Sapphire Laser"
port = "/dev/ttyUSB5"  # Silicon Labs CP2102 USB-to-UART (VALIDATED 2025-11-02)
baud_rate = 9600
wavelength = 800.0  # nm (measured: 820nm)
polling_rate_hz = 1.0
# Flow control: XON/XOFF (Software)

[instruments.newport_1830c]
type = "newport_1830c"
name = "Newport 1830-C Power Meter"
port = "/dev/ttyS0"  # Native RS-232 port (VALIDATED 2025-11-02)
baud_rate = 9600
attenuator = 0  # 0=off, 1=on
filter = 2      # 1=Slow, 2=Medium, 3=Fast
polling_rate_hz = 2.0
# Flow control: None

[instruments.elliptec]
type = "elliptec"
name = "Elliptec ELL14 Rotation Mounts"
port = "/dev/ttyUSB0"  # VALIDATED 2025-11-07 via elliptec_scanner
baud_rate = 9600
device_addresses = [2, 3]  # RS-485 addresses confirmed via device info responses
polling_rate_hz = 2.0
# Flow control: None (RS-485)

[instruments.esp300]
type = "esp300"
name = "Newport ESP300 Motion Controller"
port = "/dev/ttyUSB1"  # FTDI USB-to-Serial (VALIDATED 2025-11-02)
baud_rate = 19200
num_axes = 3
polling_rate_hz = 5.0
# Flow control: None (NOT RTS/CTS despite documentation)

[instruments.pvcam]
type = "pvcam_v2"  # V2 enables image viewing in GUI
name = "Photometrics PrimeBSI Camera"
camera_name = "PMPrimeBSI"
exposure_ms = 100.0
roi = [0, 0, 2048, 2048]  # [x, y, width, height]
binning = [1, 1]  # [x_bin, y_bin]
polling_rate_hz = 10.0  # Renamed from frame_rate_hz for consistency

# Configuration for data processing pipelines
# Each key under [processors] corresponds to an instrument ID.
# The value is an array of processor configurations to be applied in order.
[processors]
mock = [
  { type = "iir", filter_type = "Lowpass", f0 = 50.0, fs = 1000.0 },
  { type = "fft", window_size = 1024, overlap = 512, sampling_rate = 1000.0 }
]

# =============================================================================
# V3 Instruments (Phase 3) - EXPERIMENTAL
# =============================================================================
# V3 instruments use the new architecture with trait specialization and
# the InstrumentManagerV3 orchestration layer. Uncomment to enable.
#
# Note: V3 instruments are loaded separately from V1 instruments and use
# different trait implementations. IDs must be unique across both V1 and V3.

[[instruments_v3]]
id = "mock_power_meter_v3"
type = "MockPowerMeterV3"
sampling_rate = 10.0
wavelength_nm = 532.0

# [[instruments_v3]]
# id = "prime_bsi_v3"
# type = "PVCAMCameraV3"
# camera_name = "PrimeBSI"
# sdk_mode = "mock"  # set to "real" when pvcam_hardware feature is enabled
# exposure_ms = 100.0
# roi = [0, 0, 2048, 2048]
# binning = [1, 1]

[[instruments_v3]]
id = "newport_pm_v3"
type = "Newport1830CV3"
port = "/dev/ttyUSB0"
wavelength_nm = 532.0
range = "auto"
units = "watts"

# [[instruments_v3]]
# id = "elliptec_v3"
# type = "ElliptecELL14V3"
# port = "/dev/ttyUSB1"
# address = 0
# home_position_deg = 0.0

# [[instruments_v3]]
# id = "maitai_v3"
# type = "MaiTaiV3"
# port = "/dev/ttyUSB2"
# baud_rate = 9600
# wavelength_nm = 800.0

# [[instruments_v3]]
# id = "esp300_v3"
# type = "ESP300V3"
# port = "/dev/ttyUSB3"
# baud_rate = 19200
# axis = 1

# [[instruments_v3]]
# id = "pvcam_v3"
# type = "PVCAMV3"
# camera_name = "PMPrimeBSI"
# exposure_ms = 100.0
# roi_x = 0
# roi_y = 0
# roi_width = 2048
# roi_height = 2048
# bin_x = 1
# bin_y = 1
