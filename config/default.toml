# Default configuration for Rust DAQ application

# Log level: "error", "warn", "info", "debug", "trace"
log_level = "info"

[application]
# Channel capacities for data distribution
# Broadcast channel distributes data from instruments to GUI and storage
# Command channel sends control commands to instrument tasks
broadcast_channel_capacity = 1024  # Messages buffered in broadcast channel
command_channel_capacity = 32      # Commands buffered per instrument

[application.data_distributor]
# Per-subscriber channel capacity and observability thresholds
subscriber_capacity = 1024
warn_drop_rate_percent = 1.0
error_saturation_percent = 90.0
metrics_window_secs = 10

[storage]
default_path = "data_output"
default_format = "csv" # "csv", "hdf5", "arrow"

# Configuration for specific instruments
[instruments]

[instruments.mock]
type = "mock"
name = "Mock Instrument"
sample_rate_hz = 1000.0 # Increased for faster testing
num_samples = 4096      # Enough for multiple FFT windows
channels = ["sine_wave", "cosine_wave"]

[instruments.scpi_keithley]
type = "scpi_keithley"
name = "Keithley 2400 (SCPI)"
# Example for a serial-based SCPI device
# port = "/dev/ttyUSB0"
# baud_rate = 9600
# Example for a network-based SCPI device
address = "192.168.1.102"
port = 5025

[instruments.visa_rigol]
type = "visa_instrument"
name = "Rigol DS1054Z (VISA)"
resource_string = "TCPIP0::192.168.1.101::INSTR"
polling_rate_hz = 10.0
queries = { "voltage" = ":MEAS:VPP? CHAN1", "frequency" = ":MEAS:FREQ? CHAN1" }

[instruments.maitai]
type = "maitai"
name = "MaiTai Ti:Sapphire Laser"
port = "/dev/ttyUSB0"
baud_rate = 9600
wavelength = 800.0  # nm
polling_rate_hz = 1.0

[instruments.newport_1830c]
type = "newport_1830c"
name = "Newport 1830-C Power Meter"
port = "/dev/ttyUSB1"
baud_rate = 9600
wavelength = 1550.0  # nm
range = 0  # 0=autorange, 1-7=fixed ranges
units = 0  # 0=Watts, 1=dBm, 2=dB, 3=REL
polling_rate_hz = 2.0

[instruments.elliptec]
type = "elliptec"
name = "Elliptec ELL14 Rotation Mounts"
port = "/dev/ttyUSB2"
baud_rate = 9600
device_addresses = [0, 1]  # Multiple devices on RS-485 bus
polling_rate_hz = 2.0

[instruments.esp300]
type = "esp300"
name = "Newport ESP300 Motion Controller"
port = "/dev/ttyUSB3"
baud_rate = 19200
num_axes = 3
polling_rate_hz = 5.0

[instruments.pvcam]
type = "pvcam_v2"  # V2 enables image viewing in GUI
name = "Photometrics PrimeBSI Camera"
camera_name = "PMPrimeBSI"
exposure_ms = 100.0
roi = [0, 0, 2048, 2048]  # [x, y, width, height]
binning = [1, 1]  # [x_bin, y_bin]
polling_rate_hz = 10.0  # Renamed from frame_rate_hz for consistency

# Configuration for data processing pipelines
# Each key under [processors] corresponds to an instrument ID.
# The value is an array of processor configurations to be applied in order.
[processors]
mock = [
  { type = "iir", filter_type = "Lowpass", f0 = 50.0, fs = 1000.0 },
  { type = "fft", window_size = 1024, overlap = 512, sampling_rate = 1000.0 }
]

# =============================================================================
# V3 Instruments (Phase 3) - EXPERIMENTAL
# =============================================================================
# V3 instruments use the new architecture with trait specialization and
# the InstrumentManagerV3 orchestration layer. Uncomment to enable.
#
# Note: V3 instruments are loaded separately from V1 instruments and use
# different trait implementations. IDs must be unique across both V1 and V3.

[[instruments_v3]]
id = "mock_power_meter_v3"
type = "MockPowerMeterV3"
sampling_rate = 10.0
wavelength_nm = 532.0

# [[instruments_v3]]
# id = "newport_pm_v3"
# type = "Newport1830CV3"
# port = "/dev/ttyUSB0"
# wavelength_nm = 532.0
# range = "auto"
# units = "watts"

# [[instruments_v3]]
# id = "elliptec_v3"
# type = "ElliptecELL14V3"
# port = "/dev/ttyUSB1"
# address = 0
# home_position_deg = 0.0

# [[instruments_v3]]
# id = "maitai_v3"
# type = "MaiTaiV3"
# port = "/dev/ttyUSB2"
# baud_rate = 9600
# wavelength_nm = 800.0

# [[instruments_v3]]
# id = "esp300_v3"
# type = "ESP300V3"
# port = "/dev/ttyUSB3"
# baud_rate = 19200
# axis = 1

# [[instruments_v3]]
# id = "pvcam_v3"
# type = "PVCAMV3"
# camera_name = "PMPrimeBSI"
# exposure_ms = 100.0
# roi_x = 0
# roi_y = 0
# roi_width = 2048
# roi_height = 2048
# bin_x = 1
# bin_y = 1
